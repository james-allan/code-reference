<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1663659953">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1663659953">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
            </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdmin.html"><abbr title="\WooCommerceSubscriptionsAdmin">WooCommerceSubscriptionsAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsClasses.html"><abbr title="\WooCommerceSubscriptionsClasses">WooCommerceSubscriptionsClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptions.html"><abbr title="\WooCommerceSubscriptions">WooCommerceSubscriptions</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerceSubscriptions-WC.html"><abbr title="\WooCommerceSubscriptions\WC">WC</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-RestApi.html"><abbr title="\WooCommerceSubscriptions\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-WCS.html"><abbr title="\WooCommerceSubscriptions\WCS">WCS</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-SubscriptionsAPI.html"><abbr title="\WooCommerce\SubscriptionsAPI">SubscriptionsAPI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsIncludesEmails.html"><abbr title="\WooCommerce\SubscriptionsIncludesEmails">SubscriptionsIncludesEmails</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WC.html"><abbr title="\WC">WC</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WC-Subscriptions.html"><abbr title="\WC\Subscriptions">Subscriptions</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminUpgrades.html"><abbr title="\WooCommerceSubscriptionsAdminUpgrades">WooCommerceSubscriptionsAdminUpgrades</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsFunctions.html"><abbr title="\WooCommerceSubscriptionsFunctions">WooCommerceSubscriptionsFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminMetaBoxes.html"><abbr title="\WooCommerceSubscriptionsAdminMetaBoxes">WooCommerceSubscriptionsAdminMetaBoxes</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
            <li class="phpdocumentor-breadcrumb"><a href="../packages/WooCommerceSubscriptions.html">WooCommerceSubscriptions</a></li>
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wcs-limited-recurring-coupon-manager.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * A class for managing the limited payment recurring coupon feature.
 *
 * @package WooCommerce Subscriptions
 * @since   4.0.0
 */

defined( &#039;ABSPATH&#039; ) || exit;

class WCS_Limited_Recurring_Coupon_Manager {

	/**
	 * The meta key used for the number of renewals.
	 *
	 * @var string
	 */
	private static $coupons_renewals = &#039;_wcs_number_payments&#039;;

	/**
	 * Initialize the class hooks and callbacks.
	 */
	public static function init() {
		// Add custom coupon fields.
		add_action( &#039;woocommerce_coupon_options&#039;, array( __CLASS__, &#039;add_coupon_fields&#039; ), 10 );
		add_action( &#039;woocommerce_coupon_options_save&#039;, array( __CLASS__, &#039;save_coupon_fields&#039; ), 10 );

		// Filter the available payment gateways.
		add_filter( &#039;woocommerce_available_payment_gateways&#039;, array( __CLASS__, &#039;gateways_subscription_amount_changes&#039; ), 20 );

		// Check coupons when a subscription is renewed.
		add_action( &#039;woocommerce_subscription_payment_complete&#039;, array( __CLASS__, &#039;check_coupon_usages&#039; ) );

		// Add info to the Coupons list table.
		add_action( &#039;manage_shop_coupon_posts_custom_column&#039;, array( __CLASS__, &#039;add_limit_to_list_table&#039; ), 20, 2 );

		// Must be hooked later to honour early callbacks choosing to bypass the coupon removal.
		add_filter( &#039;wcs_bypass_coupon_removal&#039;, array( __CLASS__, &#039;maybe_remove_coupons_from_recurring_cart&#039; ), 1000, 5 );
	}

	/**
	 * Adds custom fields to the coupon data form.
	 *
	 * @since 4.0.0
	 */
	public static function add_coupon_fields( $id ) {
		$coupon = new WC_Coupon( $id );
		woocommerce_wp_text_input( array(
			&#039;id&#039;          =&gt; &#039;wcs_number_payments&#039;,
			&#039;label&#039;       =&gt; __( &#039;Active for x payments&#039;, &#039;woocommerce-subscriptions&#039; ),
			&#039;placeholder&#039; =&gt; __( &#039;Unlimited payments&#039;, &#039;woocommerce-subscriptions&#039; ),
			&#039;description&#039; =&gt; __( &#039;Coupon will be limited to the given number of payments. It will then be automatically removed from the subscription. &quot;Payments&quot; also includes the initial subscription payment.&#039;, &#039;woocommerce-subscriptions&#039; ),
			&#039;desc_tip&#039;    =&gt; true,
			&#039;data_type&#039;   =&gt; &#039;decimal&#039;,
			&#039;value&#039;       =&gt; $coupon-&gt;get_meta( self::$coupons_renewals ),
		) );
	}

	/**
	 * Saves our custom coupon fields.
	 *
	 * @since 4.0.0
	 * @param int $id The coupon&#039;s ID.
	 */
	public static function save_coupon_fields( $id ) {
		// Check the nonce (again).
		if ( empty( $_POST[&#039;woocommerce_meta_nonce&#039;] ) || ! wp_verify_nonce( $_POST[&#039;woocommerce_meta_nonce&#039;], &#039;woocommerce_save_data&#039; ) ) {
			return;
		}

		$coupon = new WC_Coupon( $id );
		$coupon-&gt;add_meta_data( self::$coupons_renewals, wc_clean( $_POST[&#039;wcs_number_payments&#039;] ), true );
		$coupon-&gt;save();
	}

	/**
	 * Get the number of renewals for a limited coupon.
	 *
	 * @since 4.0.0
	 * @param string $code The coupon code.
	 * @return false|int False for non-recurring coupons, or the limit number for recurring coupons.
	 *                   A value of 0 is for unlimited usage.
	 */
	public static function get_coupon_limit( $code ) {
		if ( wcs_is_woocommerce_pre( &#039;3.2&#039; ) ) {
			return false;
		}

		// Retrieve the coupon data.
		$coupon      = new WC_Coupon( $code );
		$coupon_type = $coupon-&gt;get_discount_type();

		// If we have a virtual coupon, attempt to get the original coupon.
		if ( WC_Subscriptions_Coupon::is_renewal_cart_coupon( $coupon_type ) ) {
			$coupon      = WC_Subscriptions_Coupon::map_virtual_coupon( $code );
			$coupon_type = $coupon-&gt;get_discount_type();
		}

		$limited = $coupon-&gt;get_meta( self::$coupons_renewals );

		return WC_Subscriptions_Coupon::is_recurring_coupon( $coupon_type ) ? intval( $limited ) : false;
	}

	/**
	 * Determines if a given coupon is limited to a certain number of renewals.
	 *
	 * @since 4.0.0
	 *
	 * @param string $code The coupon code.
	 * @return bool
	 */
	public static function coupon_is_limited( $code ) {
		return (bool) self::get_coupon_limit( $code );
	}

	/**
	 * Determines whether the cart contains a recurring coupon with set number of renewals.
	 *
	 * @since 4.0.0
	 * @return bool Whether the cart contains a limited recurring coupon.
	 */
	public static function cart_contains_limited_recurring_coupon() {
		$has_coupon      = false;
		$applied_coupons = isset( WC()-&gt;cart-&gt;applied_coupons ) ? WC()-&gt;cart-&gt;applied_coupons : array();

		foreach ( $applied_coupons as $code ) {
			if ( self::coupon_is_limited( $code ) ) {
				$has_coupon = true;
				break;
			}
		}

		return $has_coupon;
	}

	/**
	 * Determines if a given order has a limited use coupon.
	 *
	 * @since 4.0.0
	 * @param WC_Order|WC_Subscription $order
	 *
	 * @return bool Whether the order contains a limited recurring coupon.
	 */
	public static function order_has_limited_recurring_coupon( $order ) {
		$has_coupon = false;

		foreach ( wcs_get_used_coupon_codes( $order ) as $code ) {
			if ( self::coupon_is_limited( $code ) ) {
				$has_coupon = true;
				break;
			}
		}

		return $has_coupon;
	}

	/**
	 * Limits payment gateways to those that support changing subscription amounts.
	 *
	 * @since 4.0.0
	 * @param WC_Payment_Gateway[] $gateways The current available gateways.
	 * @return WC_Payment_Gateway[]
	 */
	private static function limit_gateways_subscription_amount_changes( $gateways ) {
		foreach ( $gateways as $index =&gt; $gateway ) {
			if ( $gateway-&gt;supports( &#039;subscriptions&#039; ) &amp;&amp; ! $gateway-&gt;supports( &#039;subscription_amount_changes&#039; ) ) {
				unset( $gateways[ $index ] );
			}
		}

		return $gateways;
	}

	/**
	 * Determines how many subscription renewals the coupon has been applied to and removes coupons which have reached their expiry.
	 *
	 * @since 4.0.0
	 * @param WC_Subscription $subscription The current subscription.
	 */
	public static function check_coupon_usages( $subscription ) {
		// If there aren&#039;t any coupons, there&#039;s nothing to do.
		$coupons = wcs_get_used_coupon_codes( $subscription );
		if ( empty( $coupons ) ) {
			return;
		}

		// Set up the coupons we&#039;re looking for, and an initial count.
		$limited_coupons = array();
		foreach ( $coupons as $code ) {
			if ( self::coupon_is_limited( $code ) ) {
				$limited_coupons[ $code ] = array(
					&#039;code&#039;  =&gt; $code,
					&#039;count&#039; =&gt; 0,
				);
			}
		}

		// Don&#039;t continue if we have no limited use coupons.
		if ( empty( $limited_coupons ) ) {
			return;
		}

		// Get all related orders, and count the number of uses for each coupon.
		$related = $subscription-&gt;get_related_orders( &#039;all&#039; );

		/** @var WC_Order $order */
		foreach ( $related as $id =&gt; $order ) {
			// Unpaid orders don&#039;t count as usages.
			if ( $order-&gt;needs_payment() ) {
				continue;
			}

			/*
			 * If the order has been refunded, treat coupon as unused. We&#039;ll consider the order to be
			 * refunded when there is a non-null refund amount, and the order total equals the refund amount.
			 *
			 * The use of == instead of === is deliberate, to account for differences in amount formatting.
			 */
			$refunded = $order-&gt;get_total_refunded();
			$total    = $order-&gt;get_total();
			if ( $refunded &amp;&amp; $total == $refunded ) {
				continue;
			}

			// If there was nothing discounted, then consider the coupon unused.
			if ( ! $order-&gt;get_discount_total() ) {
				continue;
			}

			// Check for limited coupons, and add them to the count if the provide a discount.
			$used_coupons = $order-&gt;get_items( &#039;coupon&#039; );

			/** @var WC_Order_Item_Coupon $used_coupon */
			foreach ( $used_coupons as $used_coupon ) {
				if ( isset( $limited_coupons[ $used_coupon-&gt;get_code() ] ) &amp;&amp; $used_coupon-&gt;get_discount() ) {
					$limited_coupons[ $used_coupon-&gt;get_code() ][&#039;count&#039;]++;
				}
			}
		}

		// Check each coupon to see if it needs to be removed.
		foreach ( $limited_coupons as $limited_coupon ) {
			if ( self::get_coupon_limit( $limited_coupon[&#039;code&#039;] ) &lt;= $limited_coupon[&#039;count&#039;] ) {
				$subscription-&gt;remove_coupon( $limited_coupon[&#039;code&#039;] );
				$subscription-&gt;add_order_note( sprintf(
					/* translators: %1$s is the coupon code, %2$d is the number of payment usages */
					_n(
						&#039;Limited use coupon &quot;%1$s&quot; removed from subscription. It has been used %2$d time.&#039;,
						&#039;Limited use coupon &quot;%1$s&quot; removed from subscription. It has been used %2$d times.&#039;,
						$limited_coupon[&#039;count&#039;],
						&#039;woocommerce-subscriptions&#039;
					),
					$limited_coupon[&#039;code&#039;],
					number_format_i18n( $limited_coupon[&#039;count&#039;] )
				) );
			}
		}
	}

	/**
	 * Add our limited coupon data to the Coupon list table.
	 *
	 * @since 4.0.0
	 *
	 * @param string $column_name The name of the current column in the table.
	 * @param int    $id          The coupon ID.
	 */
	public static function add_limit_to_list_table( $column_name, $id ) {
		if ( &#039;usage&#039; !== $column_name ) {
			return;
		}

		$limit = self::get_coupon_limit( wc_get_coupon_code_by_id( $id ) );
		if ( false === $limit ) {
			return;
		}

		echo &#039;&lt;br&gt;&#039;;
		if ( $limit ) {
			echo esc_html( sprintf(
				/* translators: %d refers to the number of payments the coupon can be used for. */
				_n( &#039;Active for %d payment&#039;, &#039;Active for %d payments&#039;, $limit, &#039;woocommerce-subscriptions&#039; ),
				number_format_i18n( $limit )
			) );
		} else {
			esc_html_e( &#039;Active for unlimited payments&#039;, &#039;woocommerce-subscriptions&#039; );
		}
	}

	/**
	 * Determines if a given recurring cart contains a limited use coupon which when applied to a subscription will reach its usage limit within the subscription&#039;s length.
	 *
	 * @since 4.0.0
	 *
	 * @param WC_Cart $recurring_cart The recurring cart object.
	 * @return bool
	 */
	public static function recurring_cart_contains_expiring_coupon( $recurring_cart ) {
		$limited_recurring_coupons = array();

		if ( isset( $recurring_cart-&gt;applied_coupons ) ) {
			$limited_recurring_coupons = array_filter( $recurring_cart-&gt;applied_coupons, array( __CLASS__, &#039;coupon_is_limited&#039; ) );
		}

		// Bail early if there are no limited coupons applied to the recurring cart or if there is no discount provided.
		if ( empty( $limited_recurring_coupons ) || ! $recurring_cart-&gt;discount_cart ) {
			return false;
		}

		$has_expiring_coupon   = false;
		$subscription_length   = wcs_cart_pluck( $recurring_cart, &#039;subscription_length&#039; );
		$subscription_payments = $subscription_length / wcs_cart_pluck( $recurring_cart, &#039;subscription_period_interval&#039; );

		// Limited recurring coupons will always expire at some point on subscriptions with no length.
		if ( empty( $subscription_length ) ) {
			$has_expiring_coupon = true;
		} else {
			foreach ( $limited_recurring_coupons as $code ) {
				if ( WC_Subscriptions_Coupon::get_coupon_limit( $code ) &lt; $subscription_payments ) {
					$has_expiring_coupon = true;
					break;
				}
			}
		}

		return $has_expiring_coupon;
	}

	/**
	 * Filters the available gateways when there is a recurring coupon.
	 *
	 * @since 4.0.0
	 *
	 * @param WC_Payment_Gateway[] $gateways The available payment gateways.
	 * @return WC_Payment_Gateway[] The filtered payment gateways.
	 */
	public static function gateways_subscription_amount_changes( $gateways ) {

		// If there are already no gateways or we&#039;re on the order-pay screen, bail early.
		if ( empty( $gateways ) || is_wc_endpoint_url( &#039;order-pay&#039; ) ) {
			return $gateways;
		}

		// See if this is a request to change payment for an existing subscription.
		$change_payment     = isset( $_GET[&#039;change_payment_method&#039;] ) ? wc_clean( $_GET[&#039;change_payment_method&#039;] ) : 0;
		$has_limited_coupon = false;

		if ( $change_payment &amp;&amp; isset( $_GET[&#039;_wpnonce&#039;] ) &amp;&amp; wp_verify_nonce( $_GET[&#039;_wpnonce&#039;] ) ) {
			$subscription       = wcs_get_subscription( $change_payment );
			$has_limited_coupon = self::order_has_limited_recurring_coupon( $subscription );
		}

		// If the cart doesn&#039;t have a limited coupon, and a change payment doesn&#039;t have a limited coupon, bail early.
		if ( ! self::cart_contains_limited_recurring_coupon() &amp;&amp; ! $has_limited_coupon ) {
			return $gateways;
		}

		// If we got this far, we should limit the gateways as needed.
		$gateways = self::limit_gateways_subscription_amount_changes( $gateways );

		// If there are no gateways now, it&#039;s because of the coupon. Filter the &#039;no available payment methods&#039; message.
		if ( empty( $gateways ) ) {
			add_filter( &#039;woocommerce_no_available_payment_methods_message&#039;, array( __CLASS__, &#039;no_available_payment_methods_message&#039; ), 20 );
		}

		return $gateways;
	}

	/**
	 * Filter the message for when no payment gateways are available.
	 *
	 * @since 4.0.0
	 *
	 * @param string $message The current message indicating there are no payment methods available..
	 * @return string The filtered message indicating there are no payment methods available.
	 */
	public static function no_available_payment_methods_message() {
		return __( &#039;Sorry, it seems there are no available payment methods which support the recurring coupon you are using. Please contact us if you require assistance or wish to make alternate arrangements.&#039;, &#039;woocommerce-subscriptions&#039; );
	}

	/**
	 * Removes limited coupons from the recurring cart if the coupons limit is reached in the initial cart.
	 *
	 * @since 4.0.0
	 *
	 * @param bool      $bypass_default_checks Whether to bypass WC Subscriptions default conditions for removing a coupon.
	 * @param WC_Coupon $coupon                The coupon to check.
	 * @param string    $coupon_type           The coupon&#039;s type.
	 * @param string    $calculation_type      The WC Subscriptions cart calculation mode. Can be &#039;recurring_total&#039; or &#039;none&#039;. @see WC_Subscriptions_Cart::get_calculation_type()
	 *
	 * @return bool Whether to bypass WC Subscriptions default conditions for removing a coupon.
	 */
	public static function maybe_remove_coupons_from_recurring_cart( $bypass_default_checks, $coupon, $coupon_type, $calculation_type, $cart ) {

		// Bypass this check if a third-party has already opted to bypass default conditions.
		if ( $bypass_default_checks ) {
			return $bypass_default_checks;
		}

		if ( &#039;recurring_total&#039; !== $calculation_type ) {
			return $bypass_default_checks;
		}

		if ( ! WC_Subscriptions_Coupon::is_recurring_coupon( $coupon_type ) ) {
			return $bypass_default_checks;
		}

		// Special handling for a single payment coupon.
		if ( 1 === self::get_coupon_limit( $coupon-&gt;get_code() ) &amp;&amp; 0 &lt; WC()-&gt;cart-&gt;get_coupon_discount_amount( $coupon-&gt;get_code() ) ) {
			$cart-&gt;remove_coupon( $coupon-&gt;get_code() );
		}

		return $bypass_default_checks;
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on September 20th, 2022 at 07:45 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1663659953"></script>
    <script src="../js/search.js?updated=1663659953"></script>
</body>
</html>
