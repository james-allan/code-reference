<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1663659953">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1663659953">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
            </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdmin.html"><abbr title="\WooCommerceSubscriptionsAdmin">WooCommerceSubscriptionsAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsClasses.html"><abbr title="\WooCommerceSubscriptionsClasses">WooCommerceSubscriptionsClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptions.html"><abbr title="\WooCommerceSubscriptions">WooCommerceSubscriptions</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerceSubscriptions-WC.html"><abbr title="\WooCommerceSubscriptions\WC">WC</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-RestApi.html"><abbr title="\WooCommerceSubscriptions\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-WCS.html"><abbr title="\WooCommerceSubscriptions\WCS">WCS</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-SubscriptionsAPI.html"><abbr title="\WooCommerce\SubscriptionsAPI">SubscriptionsAPI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsIncludesEmails.html"><abbr title="\WooCommerce\SubscriptionsIncludesEmails">SubscriptionsIncludesEmails</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WC.html"><abbr title="\WC">WC</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WC-Subscriptions.html"><abbr title="\WC\Subscriptions">Subscriptions</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminUpgrades.html"><abbr title="\WooCommerceSubscriptionsAdminUpgrades">WooCommerceSubscriptionsAdminUpgrades</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsFunctions.html"><abbr title="\WooCommerceSubscriptionsFunctions">WooCommerceSubscriptionsFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminMetaBoxes.html"><abbr title="\WooCommerceSubscriptionsAdminMetaBoxes">WooCommerceSubscriptionsAdminMetaBoxes</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
            <li class="phpdocumentor-breadcrumb"><a href="../packages/WooCommerce.html">WooCommerce</a></li>
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wc-api-subscriptions.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * WooCommerce Subscriptions API Subscriptions Class
 *
 * Handles requests to the /subscriptions endpoint
 *
 * @author      Prospress
 * @category    API
 * @since       2.0
 */

if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit; // Exit if accessed directly
}

class WC_API_Subscriptions extends WC_API_Orders {

	/* @var string $base the route base */
	protected $base = &#039;/subscriptions&#039;;

	/**
	 * Register the routes for this class
	 *
	 * GET|POST /subscriptions
	 * GET /subscriptions/count
	 * GET|PUT|DELETE /subscriptions/&lt;subscription_id&gt;
	 * GET /subscriptions/&lt;subscription_id&gt;/notes
	 * GET /subscriptions/&lt;subscription_id&gt;/notes/&lt;id&gt;
	 * GET /subscriptions/&lt;subscription_id&gt;/orders
	 *
	 * @since 2.0
	 * @param array $routes
	 * @return array $routes
	 */
	public function register_routes( $routes ) {

		$this-&gt;post_type = &#039;shop_subscription&#039;;

		# GET /subscriptions
		$routes[ $this-&gt;base ] = array(
			array( array( $this, &#039;get_subscriptions&#039; ), WC_API_Server::READABLE ),
			array( array( $this, &#039;create_subscription&#039; ), WC_API_Server::CREATABLE | WC_API_Server::ACCEPT_DATA ),
		);

		# GET /subscriptions/count
		$routes[ $this-&gt;base . &#039;/count&#039; ] = array(
			array( array( $this, &#039;get_subscription_count&#039; ), WC_API_Server::READABLE ),
		);

		# GET /subscriptions/statuses
		$routes[ $this-&gt;base . &#039;/statuses&#039; ] = array(
			array( array( $this, &#039;get_statuses&#039; ), WC_API_Server::READABLE ),
		);

		# GET|PUT|DELETE /subscriptions/&lt;subscription_id&gt;
		$routes[ $this-&gt;base . &#039;/(?P&lt;subscription_id&gt;\d+)&#039; ] = array(
			array( array( $this, &#039;get_subscription&#039; ), WC_API_Server::READABLE ),
			array( array( $this, &#039;edit_subscription&#039; ), WC_API_Server::EDITABLE | WC_API_Server::ACCEPT_DATA ),
			array( array( $this, &#039;delete_subscription&#039; ), WC_API_Server::DELETABLE ),
		);

		# GET /subscriptions/&lt;subscription_id&gt;/notes
		$routes[ $this-&gt;base . &#039;/(?P&lt;subscription_id&gt;\d+)/notes&#039; ] = array(
			array( array( $this, &#039;get_subscription_notes&#039; ), WC_API_Server::READABLE ),
			array( array( $this, &#039;create_subscription_note&#039; ), WC_API_Server::CREATABLE | WC_API_Server::ACCEPT_DATA ),
		);

		# GET /subscriptions/&lt;subscription_id&gt;/notes/&lt;id&gt;
		$routes[ $this-&gt;base . &#039;/(?P&lt;subscription_id&gt;\d+)/notes/(?P&lt;id&gt;\d+)&#039; ] = array(
			array( array( $this, &#039;get_subscription_note&#039; ), WC_API_Server::READABLE ),
			array( array( $this, &#039;edit_subscription_note&#039; ), WC_API_SERVER::EDITABLE | WC_API_Server::ACCEPT_DATA ),
			array( array( $this, &#039;delete_subscription_note&#039; ), WC_API_SERVER::DELETABLE ),
		);

		# GET /subscriptions/&lt;subscription_id&gt;/orders
		$routes[ $this-&gt;base . &#039;/(?P&lt;subscription_id&gt;\d+)/orders&#039; ] = array(
			array( array( $this, &#039;get_all_subscription_orders&#039; ), WC_API_Server::READABLE ),
		);

		return $routes;
	}

	/**
	 * Ensures the statuses are in the correct format and are valid subscription statues.
	 *
	 * @since 2.0
	 * @param $status string | array
	 */
	protected function format_statuses( $status = null ) {
		$statuses = &#039;any&#039;;

		if ( ! empty( $status ) ) {
			// get list of statuses and check each on is in the correct format and is valid
			$statuses = explode( &#039;,&#039;, $status );

			// attach the wc- prefix to those statuses that have not specified it
			foreach ( $statuses as &amp;$status ) {
				if ( &#039;wc-&#039; != substr( $status, 0, 3 ) ) {
					$status = &#039;wc-&#039; . $status;

					if ( ! array_key_exists( $status, wcs_get_subscription_statuses() ) ) {
						return new WP_Error( &#039;wcs_api_invalid_subscription_status&#039;, __( &#039;Invalid subscription status given.&#039;, &#039;woocommerce-subscriptions&#039; ) );
					}
				}
			}
		}

		return $statuses;
	}

	/**
	 * Gets all subscriptions
	 *
	 * @since 2.0
	 * @param null $fields
	 * @param array $filter
	 * @param null $status
	 * @param null $page
	 * @return array
	 */
	public function get_subscriptions( $fields = null, $filter = array(), $status = null, $page = 1 ) {
		// check user permissions
		if ( ! current_user_can( &#039;read_private_shop_orders&#039; ) ) {
			return new WP_Error( &#039;wcs_api_user_cannot_read_subscription_count&#039;, __( &#039;You do not have permission to read the subscriptions count&#039;, &#039;woocommerce-subscriptions&#039; ), array( &#039;status&#039; =&gt; 401 ) );
		}

		$status = $this-&gt;format_statuses( $status );

		if ( is_wp_error( $status ) ) {
			return $status;
		}

		$filter[&#039;page&#039;] = $page;

		$base_args = array(
			&#039;post_status&#039; =&gt; $status,
			&#039;post_type&#039;   =&gt; &#039;shop_subscription&#039;,
			&#039;fields&#039;      =&gt; &#039;ids&#039;,
		);

		$subscriptions = array();
		$query_args    = array_merge( $base_args, $filter );
		$query         = $this-&gt;query_orders( $query_args );

		foreach ( $query-&gt;posts as $subscription_id ) {

			if ( ! $this-&gt;is_readable( $subscription_id ) ) {
				continue;
			}

			$subscriptions[] = current( $this-&gt;get_subscription( $subscription_id, $fields, $filter ) );
		}

		$this-&gt;server-&gt;add_pagination_headers( $query );

		return array( &#039;subscriptions&#039; =&gt; apply_filters( &#039;wcs_api_get_subscriptions_response&#039;, $subscriptions, $fields, $filter, $status, $page, $this-&gt;server ) );
	}

	/**
	 * Creating Subscription.
	 *
	 * @since 2.0
	 * @param array data raw order data
	 * @return array
	 */
	public function create_subscription( $data ) {

		$data = isset( $data[&#039;subscription&#039;] ) ? $data[&#039;subscription&#039;] : array();

		try {

			if ( ! current_user_can( &#039;publish_shop_orders&#039; ) ) {
				throw new WC_API_Exception( &#039;wcs_api_user_cannot_create_subscription&#039;, __( &#039;You do not have permission to create subscriptions&#039;, &#039;woocommerce-subscriptions&#039; ), 401 );
			}

			$data[&#039;order&#039;] = $data;

			remove_filter( &#039;woocommerce_api_order_response&#039;, array( WC()-&gt;api-&gt;WC_API_Customers, &#039;add_customer_data&#039; ), 10 );

			$subscription = $this-&gt;create_order( $data );

			add_filter( &#039;woocommerce_api_order_response&#039;, array( WC()-&gt;api-&gt;WC_API_Customers, &#039;add_customer_data&#039; ), 10, 2 );

			unset( $data[&#039;order&#039;] );

			if ( is_wp_error( $subscription ) ) {
				$data = $subscription-&gt;get_error_data();
				throw new WC_API_Exception( $subscription-&gt;get_error_code(), $subscription-&gt;get_error_message(), $data[&#039;status&#039;] );
			}

			$subscription = wcs_get_subscription( $subscription[&#039;order&#039;][&#039;id&#039;] );
			unset( $data[&#039;billing_period&#039;] );
			unset( $data[&#039;billing_interval&#039;] );

			$this-&gt;update_schedule( $subscription, $data );

			// allow order total to be manually set, especially for those cases where there&#039;s no line items added to the subscription
			if ( isset( $data[&#039;order_total&#039;] ) ) {
				$subscription-&gt;set_total( wc_format_decimal( $data[&#039;order_total&#039;], get_option( &#039;woocommerce_price_num_decimals&#039; ) ) );
			}

			if ( isset( $data[&#039;payment_details&#039;] ) &amp;&amp; is_array( $data[&#039;payment_details&#039;] ) ) {
				$this-&gt;update_payment_method( $subscription, $data[&#039;payment_details&#039;], false );
			}

			$subscription-&gt;save();

			do_action( &#039;wcs_api_subscription_created&#039;, $subscription-&gt;get_id(), $this );

			return array( &#039;creating_subscription&#039; =&gt; $this-&gt;get_subscription( $subscription-&gt;get_id() ) );

		} catch ( WC_API_Exception $e ) {
			return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( &#039;status&#039; =&gt; $e-&gt;getCode() ) );
		} catch ( Exception $e ) {
			$response = array(
				&#039;error&#039;,
				array(
					&#039;wcs_api_error_create_subscription&#039; =&gt; array(
						&#039;message&#039; =&gt; $e-&gt;getMessage(),
						&#039;status&#039;  =&gt; $e-&gt;getCode(),
					),
				),
			);

			// show the subscription in response if it was still created but errored.
			if ( ! empty( $subscription ) &amp;&amp; ! is_wp_error( $subscription ) ) {
				$response[&#039;creating_subscription&#039;] = $this-&gt;get_subscription( $subscription-&gt;get_id() );
			}

			return $response;
		}
	}

	/**
	 * Edit Subscription
	 *
	 * @since 2.0
	 * @return array
	 */
	public function edit_subscription( $subscription_id, $data, $fields = null ) {
		$data = apply_filters( &#039;wcs_api_edit_subscription_data&#039;, isset( $data[&#039;subscription&#039;] ) ? $data[&#039;subscription&#039;] : array(), $subscription_id, $fields );

		try {

			$subscription_id = $this-&gt;validate_request( $subscription_id, $this-&gt;post_type, &#039;edit&#039; );

			if ( is_wp_error( $subscription_id ) ) {
				throw new WC_API_Exception( &#039;wcs_api_cannot_edit_subscription&#039;, __( &#039;The requested subscription cannot be edited.&#039;, &#039;woocommerce-subscriptions&#039; ), 400 );
			}

			$subscription = wcs_get_subscription( $subscription_id );

			if ( isset( $data[&#039;payment_details&#039;] ) &amp;&amp; is_array( $data[&#039;payment_details&#039;] ) ) {

				if ( empty( $data[&#039;payment_details&#039;][&#039;method_id&#039;] ) || &#039;manual&#039; == $data[&#039;payment_details&#039;][&#039;method_id&#039;] ) {
					$subscription-&gt;set_payment_method( &#039;&#039; );
				} else {
					$this-&gt;update_payment_method( $subscription, $data[&#039;payment_details&#039;], true );
				}
			}

			if ( ! empty( $data[&#039;order_id&#039;] ) ) {
				$subscription-&gt;set_parent_id( $data[&#039;order_id&#039;] );
			}

			// set $data[&#039;order&#039;] = $data[&#039;subscription&#039;] so that edit_order can read in the request
			$data[&#039;order&#039;] = $data;
			// edit subscription by calling WC_API_Orders::edit_order()
			$edited = $this-&gt;edit_order( $subscription_id, $data, $fields );
			// remove part of the array that isn&#039;t being used
			unset( $data[&#039;order&#039;] );

			if ( is_wp_error( $edited ) ) {
				$data = $edited-&gt;get_error_data();
				// translators: placeholder is error message
				throw new WC_API_Exception( &#039;wcs_api_cannot_edit_subscription&#039;, sprintf( _x( &#039;Edit subscription failed with error: %s&#039;, &#039;API error message when editing the order failed&#039;, &#039;woocommerce-subscriptions&#039; ), $edited-&gt;get_error_message() ), $data[&#039;status&#039;] );
			}

			$this-&gt;update_schedule( $subscription, $data );

			$subscription-&gt;save();

			do_action( &#039;wcs_api_subscription_updated&#039;, $subscription_id, $data, $this );

			return $this-&gt;get_subscription( $subscription_id );

		} catch ( WC_API_Exception $e ) {
			return new WP_Error( $e-&gt;getErrorCode(), $e-&gt;getMessage(), array( &#039;status&#039; =&gt; $e-&gt;getCode() ) );

		} catch ( Exception $e ) {
			return new WP_Error( &#039;wcs_api_cannot_edit_subscription&#039;, $e-&gt;getMessage(), array( &#039;status&#039; =&gt; $e-&gt;getCode() ) );

		}

	}

	/**
	 * Setup the new payment information to call WC_Subscription::set_payment_method()
	 *
	 * @param $subscription WC_Subscription
	 * @param $payment_details array payment data from api request
	 * @since 2.0
	 */
	public function update_payment_method( $subscription, $payment_details, $updating ) {
		$payment_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();
		$payment_method   = ( ! empty( $payment_details[&#039;method_id&#039;] ) ) ? $payment_details[&#039;method_id&#039;] : &#039;manual&#039;;
		$payment_gateway  = ( isset( $payment_gateways[ $payment_details[&#039;method_id&#039;] ] ) ) ? $payment_gateways[ $payment_details[&#039;method_id&#039;] ] : &#039;&#039;;

		try {
			$transaction = new WCS_SQL_Transaction();
			$transaction-&gt;start();

			if ( $updating &amp;&amp; ! array_key_exists( $payment_method, WCS_Change_Payment_Method_Admin::get_valid_payment_methods( $subscription ) ) ) {
				throw new Exception( &#039;wcs_api_edit_subscription_error&#039;, __( &#039;Gateway does not support admin changing the payment method on a Subscription.&#039;, &#039;woocommerce-subscriptions&#039; ) );
			}

			$payment_method_meta = apply_filters( &#039;woocommerce_subscription_payment_meta&#039;, array(), $subscription );

			if ( ! empty( $payment_gateway ) &amp;&amp; isset( $payment_method_meta[ $payment_gateway-&gt;id ] ) ) {
				$payment_method_meta = $payment_method_meta[ $payment_gateway-&gt;id ];

				if ( ! empty( $payment_method_meta ) ) {

					foreach ( $payment_method_meta as $meta_table =&gt; $meta ) {

						if ( ! is_array( $meta ) ) {
							continue;
						}

						foreach ( $meta as $meta_key =&gt; $meta_data ) {

							if ( isset( $payment_details[ $meta_table ][ $meta_key ] ) ) {
								$payment_method_meta[ $meta_table ][ $meta_key ][&#039;value&#039;] = $payment_details[ $meta_table ][ $meta_key ];
							}
						}
					}
				}
			}

			if ( &#039;&#039; == $subscription-&gt;get_payment_method() ) {
				$subscription-&gt;set_payment_method( $payment_gateway );
			}

			$subscription-&gt;set_payment_method( $payment_gateway, $payment_method_meta );

			$transaction-&gt;commit();

		} catch ( Exception $e ) {
			$transaction-&gt;rollback();

			// translators: 1$: gateway id, 2$: error message
			throw new Exception( sprintf( __( &#039;Subscription payment method could not be set to %1$s and has been set to manual with error message: %2$s&#039;, &#039;woocommerce-subscriptions&#039; ), ( ! empty( $payment_gateway-&gt;id ) ) ? $payment_gateway-&gt;id : &#039;manual&#039;, $e-&gt;getMessage() ) );
		}
	}

	/**
	 * Override WC_API_Order::create_base_order() to create a subscription
	 * instead of a WC_Order when calling WC_API_Order::create_order().
	 *
	 * @since 2.0
	 * @param $array
	 * @return WC_Subscription
	 */
	protected function create_base_order( $args, $data ) {

		$args[&#039;order_id&#039;]         = ( ! empty( $data[&#039;order_id&#039;] ) ) ? $data[&#039;order_id&#039;] : &#039;&#039;;
		$args[&#039;billing_interval&#039;] = ( ! empty( $data[&#039;billing_interval&#039;] ) ) ? $data[&#039;billing_interval&#039;] : &#039;&#039;;
		$args[&#039;billing_period&#039;]   = ( ! empty( $data[&#039;billing_period&#039;] ) ) ? $data[&#039;billing_period&#039;] : &#039;&#039;;

		return wcs_create_subscription( $args );
	}

	/**
	 * Update all subscription specific meta (i.e. Billing interval/period and date fields )
	 *
	 * @since 2.0
	 * @param $data array
	 * @param $subscription WC_Subscription
	 */
	protected function update_schedule( $subscription, $data ) {

		if ( isset( $data[&#039;billing_interval&#039;] ) ) {

			$interval = absint( $data[&#039;billing_interval&#039;] );

			if ( 0 == $interval ) {
				throw new WC_API_Exception( &#039;wcs_api_invalid_subscription_meta&#039;, __( &#039;Invalid subscription billing interval given. Must be an integer greater than 0.&#039;, &#039;woocommerce-subscriptions&#039; ), 400 );
			}

			$subscription-&gt;set_billing_interval( $interval );
		}

		if ( ! empty( $data[&#039;billing_period&#039;] ) ) {

			$period = strtolower( $data[&#039;billing_period&#039;] );

			if ( ! in_array( $period, array_keys( wcs_get_subscription_period_strings() ) ) ) {
				throw new WC_API_Exception( &#039;wcs_api_invalid_subscription_meta&#039;, __( &#039;Invalid subscription billing period given.&#039;, &#039;woocommerce-subscriptions&#039; ), 400 );
			}

			$subscription-&gt;set_billing_period( $period );
		}

		$dates_to_update = array();

		foreach ( array( &#039;start&#039;, &#039;trial_end&#039;, &#039;end&#039;, &#039;next_payment&#039; ) as $date_type ) {
			if ( isset( $data[ $date_type . &#039;_date&#039; ] ) ) {
				$dates_to_update[ $date_type ] = $data[ $date_type . &#039;_date&#039; ];
			}
		}

		if ( ! empty( $dates_to_update ) ) {
			$subscription-&gt;update_dates( $dates_to_update );
		}

	}

	/**
	 * Delete subscription
	 *
	 * @since 2.0
	 */
	public function delete_subscription( $subscription_id, $force = false ) {

		$subscription_id = $this-&gt;validate_request( $subscription_id, $this-&gt;post_type, &#039;delete&#039; );

		if ( is_wp_error( $subscription_id ) ) {
			return $subscription_id;
		}

		wc_delete_shop_order_transients( $subscription_id );

		do_action( &#039;woocommerce_api_delete_subscription&#039;, $subscription_id, $this );

		return $this-&gt;delete( $subscription_id, &#039;subscription&#039;, ( &#039;true&#039; === $force ) );
	}

	/**
	 * Retrieves the subscription by the given id.
	 *
	 * Called by: /subscriptions/&lt;subscription_id&gt;
	 *
	 * @since 2.0
	 * @param int $subscription_id
	 * @param array $fields
	 * @param array $filter
	 * @return array
	 */
	public function get_subscription( $subscription_id, $fields = null, $filter = array() ) {

		$subscription_id = $this-&gt;validate_request( $subscription_id, $this-&gt;post_type, &#039;read&#039; );

		if ( is_wp_error( $subscription_id ) ) {
			return $subscription_id;
		}

		$subscription      = wcs_get_subscription( $subscription_id );
		$order_data        = $this-&gt;get_order( $subscription_id );
		$subscription_data = $order_data[&#039;order&#039;];

		// Not all order meta relates to a subscription (a subscription doesn&#039;t &quot;complete&quot;)
		if ( isset( $subscription_data[&#039;completed_at&#039;] ) ) {
			unset( $subscription_data[&#039;completed_at&#039;] );
		}

		$subscription_data[&#039;billing_schedule&#039;] = array(
			&#039;period&#039;          =&gt; $subscription-&gt;get_billing_period(),
			&#039;interval&#039;        =&gt; $subscription-&gt;get_billing_interval(),
			&#039;start_at&#039;        =&gt; $this-&gt;get_formatted_datetime( $subscription, &#039;start&#039; ),
			&#039;trial_end_at&#039;    =&gt; $this-&gt;get_formatted_datetime( $subscription, &#039;trial_end&#039; ),
			&#039;next_payment_at&#039; =&gt; $this-&gt;get_formatted_datetime( $subscription, &#039;next_payment&#039; ),
			&#039;end_at&#039;          =&gt; $this-&gt;get_formatted_datetime( $subscription, &#039;end&#039; ),
		);

		if ( $subscription-&gt;get_parent_id() ) {
			$subscription_data[&#039;parent_order_id&#039;] = $subscription-&gt;get_parent_id();
		} else {
			$subscription_data[&#039;parent_order_id&#039;] = array();
		}

		return array( &#039;subscription&#039; =&gt; apply_filters( &#039;wcs_api_get_subscription_response&#039;, $subscription_data, $fields, $filter, $this-&gt;server ) );
	}

	/**
	 * Returns a list of all the available subscription statuses.
	 *
	 * @see wcs_get_subscription_statuses() in wcs-functions.php
	 * @since 2.0
	 * @return array
	 *
	 */
	public function get_statuses() {
		return array( &#039;subscription_statuses&#039; =&gt; wcs_get_subscription_statuses() );
	}

	/**
	 * Get the total number of subscriptions
	 *
	 * Called by: /subscriptions/count
	 * @since 2.0
	 * @param $status string
	 * @param $filter array
	 * @return int | WP_Error
	 */
	public function get_subscription_count( $status = null, $filter = array() ) {
		return $this-&gt;get_orders_count( $status, $filter );
	}

	/**
	 * Returns all the notes tied to the subscription
	 *
	 * Called by: subscription/&lt;subscription_id&gt;/notes
	 * @since 2.0
	 * @param $subscription_id
	 * @param $fields
	 * @return WP_Error|array
	 */
	public function get_subscription_notes( $subscription_id, $fields = null ) {

		$notes = $this-&gt;get_order_notes( $subscription_id, $fields );

		if ( is_wp_error( $notes ) ) {
			return $notes;
		}

		return array( &#039;subscription_notes&#039; =&gt; apply_filters( &#039;wcs_api_subscription_notes_response&#039;, $notes[&#039;order_notes&#039;], $subscription_id, $fields ) );
	}

	/**
	 * Get information about a subscription note.
	 *
	 * @since 2.0
	 * @param int $subscription_id
	 * @param int $id
	 * @param array $fields
	 *
	 * @return array Subscription note
	 */
	public function get_subscription_note( $subscription_id, $id, $fields = null ) {

		$note = $this-&gt;get_order_note( $subscription_id, $id, $fields );

		if ( is_wp_error( $note ) ) {
			return $note;
		}

		return array( &#039;subscription_note&#039; =&gt; apply_filters( &#039;wcs_api_subscription_note_response&#039;, $note[&#039;order_note&#039;], $subscription_id, $id, $fields ) );

	}

	/**
	 * Get information about a subscription note.
	 *
	 * @param int $subscription_id
	 * @param int $id
	 * @param array $fields
	 *
	 * @return WP_Error|array Subscription note
	 */
	public function create_subscription_note( $subscription_id, $data ) {

		$note = $this-&gt;create_order_note( $subscription_id, $data );

		if ( is_wp_error( $note ) ) {
			return $note;
		}

		do_action( &#039;wcs_api_created_subscription_note&#039;, $subscription_id, $note[&#039;order_note&#039;], $this );

		return array( &#039;subscription_note&#039; =&gt; $note[&#039;order_note&#039;] );
	}

	/**
	 * Verify and edit subscription note.
	 *
	 * @since 2.0
	 * @param int $subscription_id
	 * @param int $id
	 *
	 * @return WP_Error|array Subscription note edited
	 */
	public function edit_subscription_note( $subscription_id, $id, $data ) {

		$note = $this-&gt;edit_order_note( $subscription_id, $id, $data );

		if ( is_wp_error( $note ) ) {
			return $note;
		}

		do_action( &#039;wcs_api_edit_subscription_note&#039;, $subscription_id, $id, $note[&#039;order_note&#039;], $this );

		return array( &#039;subscription_note&#039; =&gt; $note[&#039;order_note&#039;] );
	}

	/**
	 * Verify and delete subscription note.
	 *
	 * @since 2.0
	 * @param int $subscription_id
	 * @param int $id
	 * @return WP_Error|array deleted subscription note status
	 */
	public function delete_subscription_note( $subscription_id, $id ) {

		$deleted_note = $this-&gt;delete_order_note( $subscription_id, $id );

		if ( is_wp_error( $deleted_note ) ) {
			return $deleted_note;
		}

		do_action( &#039;wcs_api_subscription_note_status&#039;, $subscription_id, $id, $this );

		return array( &#039;message&#039; =&gt; _x( &#039;Permanently deleted subscription note&#039;, &#039;API response confirming order note deleted from a subscription&#039;, &#039;woocommerce-subscriptions&#039; ) );

	}

	/**
	 * Get information about the initial order and renewal orders of a subscription.
	 *
	 * Called by: /subscriptions/&lt;subscription_id&gt;/orders
	 * @since 2.0
	 * @param $subscription_id
	 * @param $fields
	 */
	public function get_all_subscription_orders( $subscription_id, $filters = null ) {

		$subscription_id = $this-&gt;validate_request( $subscription_id, $this-&gt;post_type, &#039;read&#039; );

		if ( is_wp_error( $subscription_id ) ) {
			return $subscription_id;
		}

		$subscription = wcs_get_subscription( $subscription_id );

		$subscription_orders = $subscription-&gt;get_related_orders();

		$formatted_orders = array();

		if ( ! empty( $subscription_orders ) ) {

			// set post_type back to shop order so that get_orders doesn&#039;t try return a subscription.
			$this-&gt;post_type = &#039;shop_order&#039;;

			foreach ( $subscription_orders as $order_id ) {
				$formatted_orders[] = $this-&gt;get_order( $order_id );
			}

			$this-&gt;post_type = &#039;shop_subscription&#039;;

		}

		return array( &#039;subscription_orders&#039; =&gt; apply_filters( &#039;wcs_api_subscription_orders_response&#039;, $formatted_orders, $subscription_id, $filters, $this-&gt;server ) );
	}

	/**
	 * Get a certain date for a subscription, if it exists, formatted for return
	 *
	 * @since 2.0
	 * @param $subscription
	 * @param $date_type
	 */
	protected function get_formatted_datetime( $subscription, $date_type ) {

		$timestamp = $subscription-&gt;get_time( $date_type );

		if ( $timestamp &gt; 0 ) {
			$formatted_datetime = $this-&gt;server-&gt;format_datetime( $timestamp );
		} else {
			$formatted_datetime = &#039;&#039;;
		}

		return $formatted_datetime;
	}

	/**
	 * Helper method to get order post objects
	 *
	 * We need to override WC_API_Orders::query_orders() because it uses wc_get_order_statuses()
	 * for the query, but subscriptions use the values returned by wcs_get_subscription_statuses().
	 *
	 * @since 2.0
	 * @param array $args request arguments for filtering query
	 * @return WP_Query
	 */
	protected function query_orders( $args ) {

		// set base query arguments
		$query_args = array(
			&#039;fields&#039;      =&gt; &#039;ids&#039;,
			&#039;post_type&#039;   =&gt; $this-&gt;post_type,
			&#039;post_status&#039; =&gt; array_keys( wcs_get_subscription_statuses() ),
		);

		// add status argument
		if ( ! empty( $args[&#039;status&#039;] ) ) {

			$statuses                  = &#039;wc-&#039; . str_replace( &#039;,&#039;, &#039;,wc-&#039;, $args[&#039;status&#039;] );
			$statuses                  = explode( &#039;,&#039;, $statuses );
			$query_args[&#039;post_status&#039;] = $statuses;

			unset( $args[&#039;status&#039;] );
		}

		if ( ! empty( $args[&#039;customer_id&#039;] ) ) {
			$query_args[&#039;meta_query&#039;] = array(
				array(
					&#039;key&#039;     =&gt; &#039;_customer_user&#039;,
					&#039;value&#039;   =&gt; absint( $args[&#039;customer_id&#039;] ),
					&#039;compare&#039; =&gt; &#039;=&#039;,
				),
			);
		}

		$query_args = $this-&gt;merge_query_args( $query_args, $args );

		return new WP_Query( $query_args );
	}

}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on September 20th, 2022 at 07:45 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1663659953"></script>
    <script src="../js/search.js?updated=1663659953"></script>
</body>
</html>
