<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1663738776">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1663738776">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
            </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdmin.html"><abbr title="\WooCommerceSubscriptionsAdmin">WooCommerceSubscriptionsAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsClasses.html"><abbr title="\WooCommerceSubscriptionsClasses">WooCommerceSubscriptionsClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptions.html"><abbr title="\WooCommerceSubscriptions">WooCommerceSubscriptions</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerceSubscriptions-WC.html"><abbr title="\WooCommerceSubscriptions\WC">WC</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-RestApi.html"><abbr title="\WooCommerceSubscriptions\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-WCS.html"><abbr title="\WooCommerceSubscriptions\WCS">WCS</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-GatewaysPayPal.html"><abbr title="\WooCommerceSubscriptions\GatewaysPayPal">GatewaysPayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-Privacy.html"><abbr title="\WooCommerceSubscriptions\Privacy">Privacy</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-SubscriptionsAPI.html"><abbr title="\WooCommerce\SubscriptionsAPI">SubscriptionsAPI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsIncludesEmails.html"><abbr title="\WooCommerce\SubscriptionsIncludesEmails">SubscriptionsIncludesEmails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsClassesEmails.html"><abbr title="\WooCommerce\SubscriptionsClassesEmails">SubscriptionsClassesEmails</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WC.html"><abbr title="\WC">WC</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WC-Subscriptions.html"><abbr title="\WC\Subscriptions">Subscriptions</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminUpgrades.html"><abbr title="\WooCommerceSubscriptionsAdminUpgrades">WooCommerceSubscriptionsAdminUpgrades</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsFunctions.html"><abbr title="\WooCommerceSubscriptionsFunctions">WooCommerceSubscriptionsFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminMetaBoxes.html"><abbr title="\WooCommerceSubscriptionsAdminMetaBoxes">WooCommerceSubscriptionsAdminMetaBoxes</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAbstracts.html"><abbr title="\WooCommerceSubscriptionsAbstracts">WooCommerceSubscriptionsAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsIncludes.html"><abbr title="\WooCommerceSubscriptionsIncludes">WooCommerceSubscriptionsIncludes</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceClassesEmails.html"><abbr title="\WooCommerceClassesEmails">WooCommerceClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/SkyVergeWooCommerceAPI.html"><abbr title="\SkyVergeWooCommerceAPI">SkyVergeWooCommerceAPI</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
            <li class="phpdocumentor-breadcrumb"><a href="../packages/WooCommerceSubscriptions.html">WooCommerceSubscriptions</a></li>
            <li class="phpdocumentor-breadcrumb"><a href="../packages/WooCommerceSubscriptions-GatewaysPayPal.html">GatewaysPayPal</a></li>
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wcs-paypal.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * PayPal Subscription Class.
 *
 * Filters necessary functions in the WC_Paypal class to allow for subscriptions, either via PayPal Standard (default)
 * or PayPal Express Checkout using Reference Transactions (preferred)
 *
 * @package     WooCommerce Subscriptions
 * @subpackage  Gateways/PayPal
 * @category    Class
 * @author      Prospress
 * @since       2.0
 */

if ( ! defined( &#039;ABSPATH&#039; ) ) {
	exit; // Exit if accessed directly
}

class WCS_PayPal {

	/** @var WCS_PayPal_Express_API for communicating with PayPal */
	protected static $api;

	/** @var WCS_PayPal single instance of this class */
	protected static $instance;

	/** @var Array cache of PayPal IPN Handler */
	protected static $ipn_handlers;

	/** @var Array cache of PayPal Standard settings in WooCommerce */
	protected static $paypal_settings;

	/**
	 * An internal cache of subscription IDs with a specific PayPal Standard Profile ID or Reference Transaction Billing Agreement.
	 *
	 * @var int[][]
	 */
	protected static $subscriptions_by_paypal_id = array();

	/**
	 * Main PayPal Instance, ensures only one instance is/can be loaded
	 *
	 * @see wc_paypal_express()
	 * @return WCS_PayPal
	 * @since 2.0
	 */
	public static function instance() {
		if ( is_null( self::$instance ) ) {
			self::$instance = new self();
		}
		return self::$instance;
	}

	/**
	 * Bootstraps the class and hooks required actions &amp; filters.
	 *
	 * @since 2.0
	 */
	public static function init() {

		self::$paypal_settings = self::get_options();

		// wc-api handler for express checkout transactions
		if ( ! has_action( &#039;woocommerce_api_wcs_paypal&#039; ) ) {
			add_action( &#039;woocommerce_api_wcs_paypal&#039;, __CLASS__ . &#039;::handle_wc_api&#039; );
		}

		// When necessary, set the PayPal args to be for a subscription instead of shopping cart
		add_action( &#039;woocommerce_update_options_payment_gateways_paypal&#039;, __CLASS__ . &#039;::reload_options&#039;, 100 );

		// When necessary, set the PayPal args to be for a subscription instead of shopping cart
		add_action( &#039;woocommerce_update_options_payment_gateways_paypal&#039;, __CLASS__ . &#039;::are_reference_transactions_enabled&#039;, 100 );

		// When necessary, set the PayPal args to be for a subscription instead of shopping cart
		add_filter( &#039;woocommerce_paypal_args&#039;, __CLASS__ . &#039;::get_paypal_args&#039;, 10, 2 );

		// Check a valid PayPal IPN request to see if it&#039;s a subscription *before* WCS_Gateway_Paypal::successful_request()
		add_action( &#039;valid-paypal-standard-ipn-request&#039;, __CLASS__ . &#039;::process_ipn_request&#039;, 0 );

		add_action( &#039;woocommerce_scheduled_subscription_payment_paypal&#039;, __CLASS__ . &#039;::process_subscription_payment&#039;, 10, 2 );

		// Don&#039;t copy over PayPal details to Resubscribe Orders
		add_filter( &#039;wcs_resubscribe_order_created&#039;, __CLASS__ . &#039;::remove_resubscribe_order_meta&#039;, 10, 2 );

		// Triggered by WCS_SV_API_Base::broadcast_request() whenever an API request is made
		add_action( &#039;wc_paypal_api_request_performed&#039;, __CLASS__ . &#039;::log_api_requests&#039;, 10, 2 );

		add_filter( &#039;woocommerce_subscriptions_admin_meta_boxes_script_parameters&#039;, __CLASS__ . &#039;::maybe_add_change_payment_method_warning&#039; );

		// Maybe order don&#039;t need payment because lock.
		add_filter( &#039;woocommerce_order_needs_payment&#039;, __CLASS__ . &#039;::maybe_override_needs_payment&#039;, 10, 2 );

		// Remove payment lock when order is completely paid or order is cancelled.
		add_action( &#039;woocommerce_order_status_cancelled&#039;, __CLASS__ . &#039;::maybe_remove_payment_lock&#039; );
		add_action( &#039;woocommerce_payment_complete&#039;, __CLASS__ . &#039;::maybe_remove_payment_lock&#039; );

		// Adds payment lock on order received.
		add_action( &#039;get_header&#039;, __CLASS__ . &#039;::maybe_add_payment_lock&#039; );

		// Run the IPN failure handler attach and detach functions before and after processing to catch and log any unexpected shutdowns
		add_action( &#039;valid-paypal-standard-ipn-request&#039;, &#039;WCS_PayPal_Standard_IPN_Failure_Handler::attach&#039;, -1, 1 );
		add_action( &#039;valid-paypal-standard-ipn-request&#039;, &#039;WCS_PayPal_Standard_IPN_Failure_Handler::detach&#039;, 1, 1 );

		// Remove PayPal from the available payment methods if it&#039;s disabled for subscription purchases.
		add_filter( &#039;woocommerce_available_payment_gateways&#039;, array( __CLASS__, &#039;maybe_remove_paypal_standard&#039; ) );

		WCS_PayPal_Supports::init();
		WCS_PayPal_Status_Manager::init();
		WCS_PayPal_Standard_Switcher::init();

		if ( is_admin() ) {
			WCS_PayPal_Admin::init();
		}

		WCS_PayPal_Change_Payment_Method_Admin::init();
	}

	/**
	 * Get a WooCommerce setting value for the PayPal Standard Gateway
	 *
	 * @since 2.0
	 */
	public static function get_option( $setting_key ) {

		// Post WC 3.3 PayPal&#039;s sandbox and live API credentials are stored separately. When requesting the API keys make sure we return the active keys - live or sandbox depending on the mode.
		if ( ! wcs_is_woocommerce_pre( &#039;3.3&#039; ) &amp;&amp; in_array( $setting_key, array( &#039;api_username&#039;, &#039;api_password&#039;, &#039;api_signature&#039; ) ) &amp;&amp; &#039;yes&#039; === self::get_option( &#039;testmode&#039; ) ) {
			$setting_key = &#039;sandbox_&#039; . $setting_key;
		}

		return ( isset( self::$paypal_settings[ $setting_key ] ) ) ? self::$paypal_settings[ $setting_key ] : &#039;&#039;;
	}

	/**
	 * Checks if the PayPal API credentials are set.
	 *
	 * @since 2.0
	 */
	public static function are_credentials_set() {

		$credentials_are_set = false;

		if ( &#039;&#039; !== self::get_option( &#039;api_username&#039; ) &amp;&amp; &#039;&#039; !== self::get_option( &#039;api_password&#039; ) &amp;&amp; &#039;&#039; !== self::get_option( &#039;api_signature&#039; ) ) {
			$credentials_are_set = true;
		}

		return apply_filters( &#039;wooocommerce_paypal_credentials_are_set&#039;, $credentials_are_set );
	}

	/**
	 * Checks if the PayPal account has reference transactions setup
	 *
	 * Subscriptions keeps a record of all accounts where reference transactions were found to be enabled just in case the
	 * store manager switches to and from accounts. This record is stored as a JSON encoded array in the options table.
	 *
	 * @since 2.0
	 */
	public static function are_reference_transactions_enabled( $bypass_cache = &#039;&#039; ) {

		$api_username                   = self::get_option( &#039;api_username&#039; );
		$transient_key                  = &#039;wcs_paypal_rt_enabled&#039;;
		$reference_transactions_enabled = false;

		if ( self::are_credentials_set() ) {

			$accounts_with_reference_transactions_enabled = json_decode( get_option( &#039;wcs_paypal_rt_enabled_accounts&#039;, wcs_json_encode( array() ) ) );

			if ( in_array( $api_username, $accounts_with_reference_transactions_enabled ) ) {

				$reference_transactions_enabled = true;

			} elseif ( &#039;bypass_cache&#039; === $bypass_cache || get_transient( $transient_key ) !== $api_username ) {

				if ( self::get_api()-&gt;are_reference_transactions_enabled() ) {
					$accounts_with_reference_transactions_enabled[] = $api_username;
					update_option( &#039;wcs_paypal_rt_enabled_accounts&#039;, wcs_json_encode( $accounts_with_reference_transactions_enabled ) );
					$reference_transactions_enabled = true;
				} else {
					set_transient( $transient_key, $api_username, WEEK_IN_SECONDS );
				}
			}
		}

		return apply_filters( &#039;wooocommerce_subscriptions_paypal_reference_transactions_enabled&#039;, $reference_transactions_enabled );
	}

	/**
	 * Handle WC API requests where we need to run a reference transaction API operation
	 *
	 * @since 2.0
	 */
	public static function handle_wc_api() {

		if ( ! isset( $_GET[&#039;action&#039;] ) ) {
			return;
		}

		switch ( $_GET[&#039;action&#039;] ) {

			// called when the customer is returned from PayPal after authorizing their payment, used for retrieving the customer&#039;s checkout details
			case &#039;create_billing_agreement&#039;:

				// bail if no token
				if ( ! isset( $_GET[&#039;token&#039;] ) ) {
					return;
				}

				// get token to retrieve checkout details with
				$token = esc_attr( $_GET[&#039;token&#039;] );

				try {

					$express_checkout_details_response = self::get_api()-&gt;get_express_checkout_details( $token );

					// Make sure the billing agreement was accepted
					if ( 1 == $express_checkout_details_response-&gt;get_billing_agreement_status() ) {

						$order = $express_checkout_details_response-&gt;get_order();

						if ( is_null( $order ) ) {
							throw new Exception( __( &#039;Unable to find order for PayPal billing agreement.&#039;, &#039;woocommerce-subscriptions&#039; ) );
						}

						// we need to process an initial payment
						if ( $order-&gt;get_total() &gt; 0 &amp;&amp; ! wcs_is_subscription( $order ) ) {
							$billing_agreement_response = self::get_api()-&gt;do_express_checkout( $token, $order, array(
								&#039;payment_action&#039; =&gt; &#039;Sale&#039;,
								&#039;payer_id&#039;       =&gt; $express_checkout_details_response-&gt;get_payer_id(),
							) );
						} else {
							$billing_agreement_response = self::get_api()-&gt;create_billing_agreement( $token );
						}

						if ( $billing_agreement_response-&gt;has_api_error() ) {
							throw new Exception( $billing_agreement_response-&gt;get_api_error_message(), $billing_agreement_response-&gt;get_api_error_code() );
						}

						// We&#039;re changing the payment method for a subscription, make sure we update it before updating the billing agreement ID so that an old PayPal subscription can be cancelled if the existing payment method is also PayPal
						if ( wcs_is_subscription( $order ) ) {
							WC_Subscriptions_Change_Payment_Gateway::update_payment_method( $order, &#039;paypal&#039; );
							$redirect_url = add_query_arg( &#039;utm_nooverride&#039;, &#039;1&#039;, $order-&gt;get_view_order_url() );
						}

						// Make sure PayPal is set as the payment method on the order and subscription
						$available_gateways = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();
						$payment_method     = isset( $available_gateways[ self::instance()-&gt;get_id() ] ) ? $available_gateways[ self::instance()-&gt;get_id() ] : false;
						$order-&gt;set_payment_method( $payment_method );

						// Store the billing agreement ID on the order and subscriptions
						wcs_set_paypal_id( $order, $billing_agreement_response-&gt;get_billing_agreement_id() );

						// Update payment method on all active subscriptions?
						if ( wcs_is_subscription( $order ) &amp;&amp; WC_Subscriptions_Change_Payment_Gateway::will_subscription_update_all_payment_methods( $order ) ) {
							WC_Subscriptions_Change_Payment_Gateway::update_all_payment_methods_from_subscription( $order, $payment_method-&gt;id );
						}

						foreach ( wcs_get_subscriptions_for_order( $order, array( &#039;order_type&#039; =&gt; &#039;any&#039; ) ) as $subscription ) {
							$subscription-&gt;set_payment_method( $payment_method );
							wcs_set_paypal_id( $subscription, $billing_agreement_response-&gt;get_billing_agreement_id() ); // Also saves the subscription
						}

						if ( ! wcs_is_subscription( $order ) ) {

							if ( 0 == $order-&gt;get_total() ) {
								$order-&gt;payment_complete();
							} else {
								self::process_subscription_payment_response( $order, $billing_agreement_response );
							}

							$redirect_url = add_query_arg( &#039;utm_nooverride&#039;, &#039;1&#039;, $order-&gt;get_checkout_order_received_url() );
						}

						// redirect customer to order received page
						wp_safe_redirect( esc_url_raw( $redirect_url ) );

					} else {

						wp_safe_redirect( wc_get_cart_url() );

					}
				} catch ( Exception $e ) {

					wc_add_notice( __( &#039;An error occurred, please try again or try an alternate form of payment.&#039;, &#039;woocommerce-subscriptions&#039; ), &#039;error&#039; );

					wp_redirect( wc_get_cart_url() );
				}

				exit;

			case &#039;reference_transaction_account_check&#039;:
				exit;
		}
	}

	/**
	 * Override the default PayPal standard args in WooCommerce for subscription purchases when
	 * automatic payments are enabled and when the recurring order totals is over $0.00 (because
	 * PayPal doesn&#039;t support subscriptions with a $0 recurring total, we need to circumvent it and
	 * manage it entirely ourselves.)
	 *
	 * @since 2.0
	 */
	public static function get_paypal_args( $paypal_args, $order ) {

		if ( wcs_order_contains_subscription( $order, array( &#039;parent&#039;, &#039;renewal&#039;, &#039;resubscribe&#039;, &#039;switch&#039; ) ) || wcs_is_subscription( $order ) ) {
			if ( self::are_reference_transactions_enabled() ) {
				$paypal_args = self::get_api()-&gt;get_paypal_args( $paypal_args, $order );
			} else {
				$paypal_args = WCS_PayPal_Standard_Request::get_paypal_args( $paypal_args, $order );
			}
		}

		return $paypal_args;
	}

	/**
	 * When a PayPal IPN messaged is received for a subscription transaction,
	 * check the transaction details and
	 *
	 * @link https://developer.paypal.com/docs/classic/ipn/integration-guide/IPNandPDTVariables/
	 *
	 * @since 2.0
	 */
	public static function process_ipn_request( $transaction_details ) {

		try {
			if ( ! isset( $transaction_details[&#039;txn_type&#039;] ) || ! in_array( $transaction_details[&#039;txn_type&#039;], array_merge( self::get_ipn_handler( &#039;standard&#039; )-&gt;get_transaction_types(), self::get_ipn_handler( &#039;reference&#039; )-&gt;get_transaction_types() ) ) ) {
				return;
			}

			WC_Gateway_Paypal::log( &#039;Subscription Transaction Type: &#039; . $transaction_details[&#039;txn_type&#039;] );
			WC_Gateway_Paypal::log( &#039;Subscription Transaction Details: &#039; . print_r( $transaction_details, true ) );

			if ( in_array( $transaction_details[&#039;txn_type&#039;], self::get_ipn_handler( &#039;standard&#039; )-&gt;get_transaction_types() ) ) {
				self::get_ipn_handler( &#039;standard&#039; )-&gt;valid_response( $transaction_details );
			} elseif ( in_array( $transaction_details[&#039;txn_type&#039;], self::get_ipn_handler( &#039;reference&#039; )-&gt;get_transaction_types() ) ) {
				self::get_ipn_handler( &#039;reference&#039; )-&gt;valid_response( $transaction_details );
			}
		} catch ( Exception $e ) {
			WCS_PayPal_Standard_IPN_Failure_Handler::log_unexpected_exception( $e );
		}
	}

	/**
	 * Check whether a given subscription is using reference transactions and if so process the payment.
	 *
	 * @since 2.0
	 */
	public static function process_subscription_payment( $amount, $order ) {

		// If the subscription is using reference transactions, we can process the payment ourselves
		$paypal_profile_id = wcs_get_paypal_id( wcs_get_objects_property( $order, &#039;id&#039; ) );

		if ( wcs_is_paypal_profile_a( $paypal_profile_id, &#039;billing_agreement&#039; ) ) {

			if ( 0 == $amount ) {
				$order-&gt;payment_complete();
				return;
			}

			$response = self::get_api()-&gt;do_reference_transaction( $paypal_profile_id, $order, array(
				&#039;amount&#039;         =&gt; $amount,
				&#039;invoice_number&#039; =&gt; self::get_option( &#039;invoice_prefix&#039; ) . wcs_str_to_ascii( ltrim( $order-&gt;get_order_number(), _x( &#039;#&#039;, &#039;hash before the order number. Used as a character to remove from the actual order number&#039;, &#039;woocommerce-subscriptions&#039; ) ) ),
			) );

			self::process_subscription_payment_response( $order, $response );
		}
	}

	/**
	 * Process a payment based on a response
	 *
	 * @since 2.0.9
	 */
	public static function process_subscription_payment_response( $order, $response ) {

		if ( $response-&gt;has_api_error() ) {

			$error_message = $response-&gt;get_api_error_message();

			// Some PayPal error messages end with a fullstop, others do not, we prefer our punctuation consistent, so add one if we don&#039;t already have one.
			if ( &#039;.&#039; !== substr( $error_message, -1 ) ) {
				$error_message .= &#039;.&#039;;
			}

			// translators: placeholders are PayPal API error code and PayPal API error message
			$order-&gt;update_status( &#039;failed&#039;, sprintf( __( &#039;PayPal API error: (%1$d) %2$s&#039;, &#039;woocommerce-subscriptions&#039; ), $response-&gt;get_api_error_code(), $error_message ) );

		} elseif ( $response-&gt;transaction_held() ) {

			// translators: placeholder is PayPal transaction status message
			$order_note   = sprintf( __( &#039;PayPal Transaction Held: %s&#039;, &#039;woocommerce-subscriptions&#039; ), $response-&gt;get_status_message() );
			$order_status = apply_filters( &#039;wcs_paypal_held_payment_order_status&#039;, &#039;on-hold&#039;, $order, $response );

			// mark order as held
			if ( ! $order-&gt;has_status( $order_status ) ) {
				$order-&gt;update_status( $order_status, $order_note );
			} else {
				$order-&gt;add_order_note( $order_note );
			}
		} elseif ( ! $response-&gt;transaction_approved() ) {

			// translators: placeholder is PayPal transaction status message
			$order-&gt;update_status( &#039;failed&#039;, sprintf( __( &#039;PayPal payment declined: %s&#039;, &#039;woocommerce-subscriptions&#039; ), $response-&gt;get_status_message() ) );

		} elseif ( $response-&gt;transaction_approved() ) {
			// translators: placeholder is a transaction ID.
			$order-&gt;add_order_note( sprintf( __( &#039;PayPal payment approved (ID: %s)&#039;, &#039;woocommerce-subscriptions&#039; ), $response-&gt;get_transaction_id() ) );

			$order-&gt;payment_complete( $response-&gt;get_transaction_id() );
		}
	}

	/**
	 * Don&#039;t transfer PayPal meta to resubscribe orders.
	 *
	 * @param object $resubscribe_order The order created for resubscribing the subscription
	 * @param object $subscription The subscription to which the resubscribe order relates
	 * @return object
	 * @since 2.0
	 */
	public static function remove_resubscribe_order_meta( $resubscribe_order, $subscription ) {

		$post_meta_keys = array(
			&#039;Transaction ID&#039;,
			&#039;Payer first name&#039;,
			&#039;Payer last name&#039;,
			&#039;Payer PayPal address&#039;,
			&#039;Payer PayPal first name&#039;,
			&#039;Payer PayPal last name&#039;,
			&#039;PayPal Subscriber ID&#039;,
			&#039;Payment type&#039;,
		);

		foreach ( $post_meta_keys as $post_meta_key ) {
			delete_post_meta( wcs_get_objects_property( $resubscribe_order, &#039;id&#039; ), $post_meta_key );
		}

		return $resubscribe_order;
	}

	/**
	 * Maybe adds a warning message to subscription script parameters which is used in a Javascript dialog if the
	 * payment method of the subscription is set to be changed. The warning message is only added if the subscriptions
	 * payment gateway is PayPal Standard.
	 *
	 * @param array $script_parameters The script parameters used in subscription meta boxes.
	 * @return array $script_parameters
	 * @since 2.0
	 */
	public static function maybe_add_change_payment_method_warning( $script_parameters ) {
		global $post;
		$subscription = wcs_get_subscription( $post );

		if ( &#039;paypal&#039; === $subscription-&gt;get_payment_method() ) {

			$paypal_profile_id  = wcs_get_paypal_id( $subscription-&gt;get_id() );
			$is_paypal_standard = ! wcs_is_paypal_profile_a( $paypal_profile_id, &#039;billing_agreement&#039; );

			if ( $is_paypal_standard ) {
				$script_parameters[&#039;change_payment_method_warning&#039;] = __( &quot;Are you sure you want to change the payment method from PayPal standard?\n\nThis will suspend the subscription at PayPal.&quot;, &#039;woocommerce-subscriptions&#039; );
			}
		}

		return $script_parameters;
	}

	/**
	 * This validates against payment lock for PP and returns false if we meet the criteria:
	 *  - is a parent order.
	 *  - payment method is paypal.
	 *  - PayPal Reference Transactions is disabled.
	 *  - order has lock.
	 *  - lock hasn&#039;t timeout.
	 *
	 * @param bool     $needs_payment Does this order needs to process payment?
	 * @param WC_Order $order         The actual order.
	 *
	 * @return bool
	 * @since 2.5.3
	 */
	public static function maybe_override_needs_payment( $needs_payment, $order ) {
		if ( $needs_payment &amp;&amp; self::instance()-&gt;get_id() === $order-&gt;get_payment_method() &amp;&amp; ! self::are_reference_transactions_enabled() &amp;&amp; wcs_order_contains_subscription( $order, array( &#039;parent&#039; ) ) ) {
			$has_lock            = $order-&gt;get_meta( &#039;_wcs_lock_order_payment&#039; );
			$seconds_since_order = wcs_seconds_since_order_created( $order );

			// We have lock and order hasn&#039;t meet the lock time.
			if ( $has_lock &amp;&amp; $seconds_since_order &lt; apply_filters( &#039;wcs_lock_order_payment_seconds&#039;, 180 ) ) {
				$needs_payment = false;
			}
		}

		return $needs_payment;
	}

	/**
	 * Adds payment lock meta when order is received and...
	 * - order is valid.
	 * - payment method is paypal.
	 * - order needs payment.
	 * - PayPal Reference Transactions is disabled.
	 * - order is parent order of a subscription.
	 *
	 * @since 2.5.3
	 */
	public static function maybe_add_payment_lock() {
		if ( ! wcs_is_order_received_page() ) {
			return;
		}

		global $wp;
		$order = wc_get_order( absint( $wp-&gt;query_vars[&#039;order-received&#039;] ) );

		if ( $order &amp;&amp; self::instance()-&gt;get_id() === $order-&gt;get_payment_method() &amp;&amp; $order-&gt;needs_payment() &amp;&amp; ! self::are_reference_transactions_enabled() &amp;&amp; wcs_order_contains_subscription( $order, array( &#039;parent&#039; ) ) ) {
			$order-&gt;update_meta_data( &#039;_wcs_lock_order_payment&#039;, &#039;true&#039; );
			$order-&gt;save();
		}
	}

	/**
	 * Removes payment lock when order is parent and has paypal method.
	 *
	 * @param int $order_id Order cancelled/paid.
	 *
	 * @since 2.5.3
	 */
	public static function maybe_remove_payment_lock( $order_id ) {
		$order = wc_get_order( $order_id );

		if ( self::instance()-&gt;get_id() === $order-&gt;get_payment_method() &amp;&amp; wcs_order_contains_subscription( $order, array( &#039;parent&#039; ) ) ) {
			$order-&gt;delete_meta_data( &#039;wcs_lock_order_payment&#039; );
			$order-&gt;save();
		}
	}

	/** Getters ******************************************************/

	/**
	 * Get the API object
	 *
	 * @see SV_WC_Payment_Gateway::get_api()
	 * @return WC_PayPal_Express_API API instance
	 * @since 2.0
	 */
	protected static function get_ipn_handler( $ipn_type = &#039;standard&#039; ) {

		$use_sandbox = ( &#039;yes&#039; === self::get_option( &#039;testmode&#039; ) );

		if ( &#039;reference&#039; === $ipn_type ) {

			if ( ! isset( self::$ipn_handlers[&#039;reference&#039;] ) ) {
				self::$ipn_handlers[&#039;reference&#039;] = new WCS_Paypal_Reference_Transaction_IPN_Handler( $use_sandbox, self::get_option( &#039;receiver_email&#039; ) );
			}

			$ipn_handler = self::$ipn_handlers[&#039;reference&#039;];

		} else {

			if ( ! isset( self::$ipn_handlers[&#039;standard&#039;] ) ) {
				self::$ipn_handlers[&#039;standard&#039;] = new WCS_Paypal_Standard_IPN_Handler( $use_sandbox, self::get_option( &#039;receiver_email&#039; ) );
			}

			$ipn_handler = self::$ipn_handlers[&#039;standard&#039;];

		}

		return $ipn_handler;
	}

	/**
	 * Get the API object
	 *
	 * @return WCS_PayPal_Express_API API instance
	 * @since 2.0
	 */
	public static function get_api() {

		if ( is_object( self::$api ) ) {
			return self::$api;
		}

		if ( ! class_exists( &#039;WC_Gateway_Paypal_Response&#039; ) ) {
			require_once( WC()-&gt;plugin_path() . &#039;/includes/gateways/paypal/includes/class-wc-gateway-paypal-response.php&#039; );
		}

		$environment = ( &#039;yes&#039; === self::get_option( &#039;testmode&#039; ) ) ? &#039;sandbox&#039; : &#039;production&#039;;

		return self::$api = new WCS_PayPal_Reference_Transaction_API( &#039;paypal&#039;, $environment, self::get_option( &#039;api_username&#039; ), self::get_option( &#039;api_password&#039; ), self::get_option( &#039;api_signature&#039; ) );
	}

	/**
	 * Return the default WC PayPal gateway&#039;s settings.
	 *
	 * @since 2.0
	 */
	public static function reload_options() {
		self::get_options();
	}

	/**
	 * Return the default WC PayPal gateway&#039;s settings.
	 *
	 * @since 2.0
	 */
	protected static function get_options() {

		self::$paypal_settings = get_option( &#039;woocommerce_paypal_settings&#039; );

		return self::$paypal_settings;
	}

	/** Logging **/

	/**
	 * Log API request/response data
	 *
	 * @since 2.0
	 */
	public static function log_api_requests( $request_data, $response_data ) {
		WC_Gateway_Paypal::log( &#039;Subscription Request Parameters: &#039; . print_r( $request_data, true ) );
		WC_Gateway_Paypal::log( &#039;Subscription Request Response: &#039; . print_r( $response_data, true ) );
	}

	/** Method required by WCS_SV_API_Base, which normally requires an instance of SV_WC_Plugin **/

	public function get_plugin_name() {
		return _x( &#039;WooCommerce Subscriptions PayPal&#039;, &#039;used in User Agent data sent to PayPal to help identify where a payment came from&#039;, &#039;woocommerce-subscriptions&#039; );
	}

	public function get_version() {
		return WC_Subscriptions_Core_Plugin::instance()-&gt;get_plugin_version();
	}

	public function get_id() {
		return &#039;paypal&#039;;
	}

	/**
	 * Set the default value for whether PayPal Standard is enabled or disabled for subscriptions purchases.
	 *
	 * PayPal Standard will be enabled for subscriptions when:
	 * - PayPal is enabled.
	 * - The store has existing subscriptions.
	 *
	 * In any other case, it will be disabled by default.
	 * This function is called when 2.5.0 is active for the first time. @see WC_Subscriptions_Upgrader::upgrade()
	 *
	 * @since 2.5.0
	 */
	public static function set_enabled_for_subscriptions_default() {

		// Exit early if it has already been set.
		if ( self::get_option( &#039;enabled_for_subscriptions&#039; ) ) {
			return;
		}

		// For existing stores with PayPal enabled, PayPal is automatically enabled for subscriptions.
		if ( &#039;yes&#039; === WCS_PayPal::get_option( &#039;enabled&#039; ) &amp;&amp; wcs_do_subscriptions_exist() ) {
			$default = &#039;yes&#039;;
		} else {
			$default = &#039;no&#039;;
		}

		// Find the PayPal Standard gateway instance to set the setting.
		foreach ( WC()-&gt;payment_gateways-&gt;payment_gateways as $gateway ) {
			if ( $gateway-&gt;id === &#039;paypal&#039; ) {
				wcs_update_settings_option( $gateway, &#039;enabled_for_subscriptions&#039;, $default );
				break;
			}
		}
	}

	/**
	 * Remove PayPal Standard as an available payment method if it is disabled for subscriptions.
	 *
	 * @param array $available_gateways A list of available payment methods displayed on the checkout.
	 * @return array
	 * @since 2.5.0
	 */
	public static function maybe_remove_paypal_standard( $available_gateways ) {

		if ( ! isset( $available_gateways[&#039;paypal&#039;] ) || &#039;yes&#039; === self::get_option( &#039;enabled_for_subscriptions&#039; ) || WCS_PayPal::are_reference_transactions_enabled() ) {
			return $available_gateways;
		}

		$paying_for_order = absint( get_query_var( &#039;order-pay&#039; ) );

		if (
			WC_Subscriptions_Change_Payment_Gateway::$is_request_to_change_payment ||
			WC_Subscriptions_Cart::cart_contains_subscription() ||
			wcs_cart_contains_renewal() ||
			( $paying_for_order &amp;&amp; wcs_order_contains_subscription( $paying_for_order ) )
		) {
			unset( $available_gateways[&#039;paypal&#039;] );
		}

		return $available_gateways;
	}

	/**
	 * Gets subscriptions with a given paypal subscription id.
	 *
	 * @since 2.5.4
	 * @param string $paypal_id The PayPal Standard Profile ID or PayPal Reference Transactions Billing Agreement.
	 * @param string $return    Optional. The type to return. Can be &#039;ids&#039; to return subscription IDs or &#039;objects&#039; to return WC_Subscription objects. Default &#039;ids&#039;.
	 * @return WC_Subscription[]|int[] Subscriptions (objects or IDs) with the PayPal Profile ID or Billing Agreement stored in meta.
	 */
	public static function get_subscriptions_by_paypal_id( $paypal_id, $return = &#039;ids&#039; ) {

		if ( ! isset( self::$subscriptions_by_paypal_id[ $paypal_id ] ) ) {
			$subscription_ids = get_posts( array(
				&#039;posts_per_page&#039; =&gt; -1,
				&#039;post_type&#039;      =&gt; &#039;shop_subscription&#039;,
				&#039;post_status&#039;    =&gt; &#039;any&#039;,
				&#039;fields&#039;         =&gt; &#039;ids&#039;,
				&#039;meta_query&#039;     =&gt; array(
					array(
						&#039;key&#039;     =&gt; &#039;_paypal_subscription_id&#039;,
						&#039;compare&#039; =&gt; &#039;=&#039;,
						&#039;value&#039;   =&gt; $paypal_id,
					),
				),
			) );

			self::$subscriptions_by_paypal_id[ $paypal_id ] = array_combine( $subscription_ids, $subscription_ids );
		}

		if ( &#039;objects&#039; === $return ) {
			$subscriptions = array_filter( array_map( &#039;wcs_get_subscription&#039;, self::$subscriptions_by_paypal_id[ $paypal_id ] ) );
		} else {
			$subscriptions = self::$subscriptions_by_paypal_id[ $paypal_id ];
		}

		return $subscriptions;
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on September 21st, 2022 at 05:39 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1663738776"></script>
    <script src="../js/search.js?updated=1663738776"></script>
</body>
</html>
