<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1663738776">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1663738776">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
            </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdmin.html"><abbr title="\WooCommerceSubscriptionsAdmin">WooCommerceSubscriptionsAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsClasses.html"><abbr title="\WooCommerceSubscriptionsClasses">WooCommerceSubscriptionsClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptions.html"><abbr title="\WooCommerceSubscriptions">WooCommerceSubscriptions</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerceSubscriptions-WC.html"><abbr title="\WooCommerceSubscriptions\WC">WC</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-RestApi.html"><abbr title="\WooCommerceSubscriptions\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-WCS.html"><abbr title="\WooCommerceSubscriptions\WCS">WCS</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-GatewaysPayPal.html"><abbr title="\WooCommerceSubscriptions\GatewaysPayPal">GatewaysPayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-Privacy.html"><abbr title="\WooCommerceSubscriptions\Privacy">Privacy</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-SubscriptionsAPI.html"><abbr title="\WooCommerce\SubscriptionsAPI">SubscriptionsAPI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsIncludesEmails.html"><abbr title="\WooCommerce\SubscriptionsIncludesEmails">SubscriptionsIncludesEmails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsClassesEmails.html"><abbr title="\WooCommerce\SubscriptionsClassesEmails">SubscriptionsClassesEmails</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WC.html"><abbr title="\WC">WC</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WC-Subscriptions.html"><abbr title="\WC\Subscriptions">Subscriptions</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminUpgrades.html"><abbr title="\WooCommerceSubscriptionsAdminUpgrades">WooCommerceSubscriptionsAdminUpgrades</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsFunctions.html"><abbr title="\WooCommerceSubscriptionsFunctions">WooCommerceSubscriptionsFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminMetaBoxes.html"><abbr title="\WooCommerceSubscriptionsAdminMetaBoxes">WooCommerceSubscriptionsAdminMetaBoxes</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAbstracts.html"><abbr title="\WooCommerceSubscriptionsAbstracts">WooCommerceSubscriptionsAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsIncludes.html"><abbr title="\WooCommerceSubscriptionsIncludes">WooCommerceSubscriptionsIncludes</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceClassesEmails.html"><abbr title="\WooCommerceClassesEmails">WooCommerceClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/SkyVergeWooCommerceAPI.html"><abbr title="\SkyVergeWooCommerceAPI">SkyVergeWooCommerceAPI</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
            <li class="phpdocumentor-breadcrumb"><a href="../packages/WooCommerce.html">WooCommerce</a></li>
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wc-subscriptions-addresses.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Subscriptions Address Class
 *
 * Hooks into WooCommerce to handle editing addresses for subscriptions (by editing the original order for the subscription)
 *
 * @package    WooCommerce Subscriptions
 * @subpackage WC_Subscriptions_Addresses
 * @category   Class
 * @author     Brent Shepherd
 * @since      1.3
 */
class WC_Subscriptions_Addresses {

	/**
	 * Bootstraps the class and hooks required actions &amp; filters.
	 *
	 * @since 1.3
	 */
	public static function init() {

		add_filter( &#039;wcs_view_subscription_actions&#039;, __CLASS__ . &#039;::add_edit_address_subscription_action&#039;, 10, 2 );

		add_action( &#039;template_redirect&#039;, array( __CLASS__, &#039;maybe_restrict_edit_address_endpoint&#039; ) );

		add_action( &#039;woocommerce_after_edit_address_form_billing&#039;, __CLASS__ . &#039;::maybe_add_edit_address_checkbox&#039;, 10 );
		add_action( &#039;woocommerce_after_edit_address_form_shipping&#039;, __CLASS__ . &#039;::maybe_add_edit_address_checkbox&#039;, 10 );

		add_action( &#039;woocommerce_customer_save_address&#039;, __CLASS__ . &#039;::maybe_update_subscription_addresses&#039;, 10, 2 );

		add_filter( &#039;woocommerce_address_to_edit&#039;, __CLASS__ . &#039;::maybe_populate_subscription_addresses&#039;, 10 );

		add_filter( &#039;woocommerce_get_breadcrumb&#039;, __CLASS__ . &#039;::change_addresses_breadcrumb&#039;, 10, 1 );
	}

	/**
	 * Checks if a user can edit a subscription&#039;s address.
	 *
	 * @param int|WC_Subscription $subscription Post ID of a &#039;shop_subscription&#039; post, or instance of a WC_Subscription object.
	 * @param int                 $user_id      The ID of a user.
	 * @return bool Whether the user can edit the subscription&#039;s address.
	 * @since 3.0.15
	 */
	private static function can_user_edit_subscription_address( $subscription, $user_id = 0 ) {
		$subscription = wcs_get_subscription( $subscription );
		$user_id      = empty( $user_id ) ? get_current_user_id() : absint( $user_id );

		return $subscription ? user_can( $user_id, &#039;view_order&#039;, $subscription-&gt;get_id() ) : false;
	}

	/**
	 * Add a &quot;Change Shipping Address&quot; button to the &quot;My Subscriptions&quot; table for those subscriptions
	 * which require shipping.
	 *
	 * @param array $all_actions The $subscription_id =&gt; $actions array with all actions that will be displayed for a subscription on the &quot;My Subscriptions&quot; table
	 * @param array $subscriptions All of a given users subscriptions that will be displayed on the &quot;My Subscriptions&quot; table
	 * @since 1.3
	 */
	public static function add_edit_address_subscription_action( $actions, $subscription ) {

		if ( $subscription-&gt;needs_shipping_address() &amp;&amp; $subscription-&gt;has_status( array( &#039;active&#039;, &#039;on-hold&#039; ) ) ) {
			$actions[&#039;change_address&#039;] = array(
				&#039;url&#039;  =&gt; add_query_arg( array( &#039;subscription&#039; =&gt; $subscription-&gt;get_id() ), wc_get_endpoint_url( &#039;edit-address&#039;, &#039;shipping&#039; ) ),
				&#039;name&#039; =&gt; __( &#039;Change address&#039;, &#039;woocommerce-subscriptions&#039; ),
			);
		}

		return $actions;
	}

	/**
	 * Redirects to &quot;My Account&quot; when attempting to edit the address on a subscription that doesn&#039;t belong to the user.
	 *
	 * @since 3.0.15
	 */
	public static function maybe_restrict_edit_address_endpoint() {
		if ( ! is_wc_endpoint_url() || &#039;edit-address&#039; !== WC()-&gt;query-&gt;get_current_endpoint() || ! isset( $_GET[&#039;subscription&#039;] ) ) {
			return;
		}

		if ( ! self::can_user_edit_subscription_address( absint( $_GET[&#039;subscription&#039;] ) ) ) {
			wc_add_notice( &#039;Invalid subscription.&#039;, &#039;error&#039; );
			wp_redirect( wc_get_account_endpoint_url( &#039;dashboard&#039; ) );
			exit();
		}
	}

	/**
	 * Outputs the necessary markup on the &quot;My Account&quot; &gt; &quot;Edit Address&quot; page for editing a single subscription&#039;s
	 * address or to check if the customer wants to update the addresses for all of their subscriptions.
	 *
	 * If editing their default shipping address, this function adds a checkbox to the to allow subscribers to
	 * also update the address on their active subscriptions. If editing a single subscription&#039;s address, the
	 * subscription key is added as a hidden field.
	 *
	 * @since 1.3
	 */
	public static function maybe_add_edit_address_checkbox() {
		global $wp;

		if ( wcs_user_has_subscription() ) {
			$subscription_id = isset( $_GET[&#039;subscription&#039;] ) ? absint( $_GET[&#039;subscription&#039;] ) : 0;

			if ( $subscription_id &amp;&amp; self::can_user_edit_subscription_address( $subscription_id ) ) {

				echo &#039;&lt;p&gt;&#039; . esc_html__( &#039;Both the shipping address used for the subscription and your default shipping address for future purchases will be updated.&#039;, &#039;woocommerce-subscriptions&#039; ) . &#039;&lt;/p&gt;&#039;;

				echo &#039;&lt;input type=&quot;hidden&quot; name=&quot;update_subscription_address&quot; value=&quot;&#039; . esc_attr( $subscription_id ) . &#039;&quot; id=&quot;update_subscription_address&quot; /&gt;&#039;;

			} elseif ( ( ( isset( $wp-&gt;query_vars[&#039;edit-address&#039;] ) &amp;&amp; ! empty( $wp-&gt;query_vars[&#039;edit-address&#039;] ) ) || isset( $_GET[&#039;address&#039;] ) ) ) {

				if ( isset( $wp-&gt;query_vars[&#039;edit-address&#039;] ) ) {
					$address_type = esc_attr( $wp-&gt;query_vars[&#039;edit-address&#039;] );
				} else {
					$address_type = ( ! isset( $_GET[&#039;address&#039;] ) ) ? esc_attr( $_GET[&#039;address&#039;] ) : &#039;&#039;;
				}

				// translators: $1: address type (Shipping Address / Billing Address), $2: opening &lt;strong&gt; tag, $3: closing &lt;/strong&gt; tag
				$label = sprintf( esc_html__( &#039;Update the %1$s used for %2$sall%3$s future renewals of my active subscriptions&#039;, &#039;woocommerce-subscriptions&#039; ), wcs_get_address_type_to_display( $address_type ), &#039;&lt;strong&gt;&#039;, &#039;&lt;/strong&gt;&#039; );

				woocommerce_form_field(
					&#039;update_all_subscriptions_addresses&#039;,
					array(
						&#039;type&#039;    =&gt; &#039;checkbox&#039;,
						&#039;class&#039;   =&gt; array( &#039;form-row-wide&#039; ),
						&#039;label&#039;   =&gt; $label,
						&#039;default&#039; =&gt; apply_filters( &#039;wcs_update_all_subscriptions_addresses_checked&#039;, false ),
					)
				);
			}

			wp_nonce_field( &#039;wcs_edit_address&#039;, &#039;_wcsnonce&#039; );

		}
	}

	/**
	 * When a subscriber&#039;s billing or shipping address is successfully updated, check if the subscriber
	 * has also requested to update the addresses on existing subscriptions and if so, go ahead and update
	 * the addresses on the initial order for each subscription.
	 *
	 * @param int $user_id The ID of a user who own&#039;s the subscription (and address)
	 * @since 1.3
	 */
	public static function maybe_update_subscription_addresses( $user_id, $address_type ) {

		if ( ! wcs_user_has_subscription( $user_id ) || wc_notice_count( &#039;error&#039; ) &gt; 0 || empty( $_POST[&#039;_wcsnonce&#039;] ) || ! wp_verify_nonce( $_POST[&#039;_wcsnonce&#039;], &#039;wcs_edit_address&#039; ) ) {
			return;
		}

		$address_type   = ( &#039;billing&#039; == $address_type || &#039;shipping&#039; == $address_type ) ? $address_type : &#039;&#039;;
		$address_fields = WC()-&gt;countries-&gt;get_address_fields( esc_attr( $_POST[ $address_type . &#039;_country&#039; ] ), $address_type . &#039;_&#039; );
		$address        = array();

		foreach ( $address_fields as $key =&gt; $field ) {
			if ( isset( $_POST[ $key ] ) ) {
				$address[ str_replace( $address_type . &#039;_&#039;, &#039;&#039;, $key ) ] = wc_clean( $_POST[ $key ] );
			}
		}

		if ( isset( $_POST[&#039;update_all_subscriptions_addresses&#039;] ) ) {

			$users_subscriptions = wcs_get_users_subscriptions( $user_id );

			foreach ( $users_subscriptions as $subscription ) {
				if ( $subscription-&gt;has_status( array( &#039;active&#039;, &#039;on-hold&#039; ) ) ) {
					$subscription-&gt;set_address( $address, $address_type );
				}
			}
		} elseif ( isset( $_POST[&#039;update_subscription_address&#039;] ) ) {

			$subscription = wcs_get_subscription( absint( $_POST[&#039;update_subscription_address&#039;] ) );

			if ( $subscription &amp;&amp; self::can_user_edit_subscription_address( $subscription-&gt;get_id() ) ) {
				// Update the address only if the user actually owns the subscription
				$subscription-&gt;set_address( $address, $address_type );

				wp_safe_redirect( $subscription-&gt;get_view_order_url() );
				exit();
			}
		}
	}

	/**
	 * Prepopulate the address fields on a subscription item
	 *
	 * @param array $address A WooCommerce address array
	 * @since 1.5
	 */
	public static function maybe_populate_subscription_addresses( $address ) {
		$subscription_id = isset( $_GET[&#039;subscription&#039;] ) ? absint( $_GET[&#039;subscription&#039;] ) : 0;

		if ( $subscription_id &amp;&amp; self::can_user_edit_subscription_address( $subscription_id ) ) {
			$subscription = wcs_get_subscription( $subscription_id );

			foreach ( array_keys( $address ) as $key ) {

				$function_name = &#039;get_&#039; . $key;

				if ( is_callable( array( $subscription, $function_name ) ) ) {
					$address[ $key ][&#039;value&#039;] = $subscription-&gt;$function_name();
				}
			}
		}

		return $address;
	}

	/**
	 * Update the address fields on an order
	 *
	 * @param array $subscription A WooCommerce Subscription array
	 * @param array $address_fields Locale aware address fields of the form returned by WC_Countries-&gt;get_address_fields() for a given country
	 * @since 1.3
	 */
	public static function maybe_update_order_address( $subscription, $address_fields ) {
		_deprecated_function( __METHOD__, &#039;2.0&#039;, &#039;WC_Order::set_address() or WC_Subscription::set_address()&#039; );
	}

	/**
	 * Replace the change address breadcrumbs structure to include a link back to the subscription.
	 *
	 * @param  array $crumbs
	 * @return array
	 * @since 2.4.2
	 */
	public static function change_addresses_breadcrumb( $crumbs ) {
		if ( isset( $_GET[&#039;subscription&#039;] ) &amp;&amp; is_wc_endpoint_url() &amp;&amp; &#039;edit-address&#039; === WC()-&gt;query-&gt;get_current_endpoint() ) {
			global $wp_query;
			$subscription = wcs_get_subscription( absint( $_GET[&#039;subscription&#039;] ) );

			if ( ! $subscription ) {
				return $crumbs;
			}

			$crumbs[1] = array(
				get_the_title( wc_get_page_id( &#039;myaccount&#039; ) ),
				get_permalink( wc_get_page_id( &#039;myaccount&#039; ) ),
			);

			$crumbs[2] = array(
				// translators: %s: subscription ID.
				sprintf( _x( &#039;Subscription #%s&#039;, &#039;hash before order number&#039;, &#039;woocommerce-subscriptions&#039; ), $subscription-&gt;get_order_number() ),
				esc_url( $subscription-&gt;get_view_order_url() ),
			);

			$crumbs[3] = array(
				// translators: %s: address type (eg. &#039;billing&#039; or &#039;shipping&#039;).
				sprintf( _x( &#039;Change %s address&#039;, &#039;change billing or shipping address&#039;, &#039;woocommerce-subscriptions&#039; ), $wp_query-&gt;query_vars[&#039;edit-address&#039;] ),
				&#039;&#039;,
			);
		}

		return $crumbs;
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on September 21st, 2022 at 05:39 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1663738776"></script>
    <script src="../js/search.js?updated=1663738776"></script>
</body>
</html>
