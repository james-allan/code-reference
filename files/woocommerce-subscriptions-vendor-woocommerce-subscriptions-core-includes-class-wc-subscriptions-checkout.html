<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1663738776">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1663738776">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
            </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdmin.html"><abbr title="\WooCommerceSubscriptionsAdmin">WooCommerceSubscriptionsAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsClasses.html"><abbr title="\WooCommerceSubscriptionsClasses">WooCommerceSubscriptionsClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptions.html"><abbr title="\WooCommerceSubscriptions">WooCommerceSubscriptions</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerceSubscriptions-WC.html"><abbr title="\WooCommerceSubscriptions\WC">WC</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-RestApi.html"><abbr title="\WooCommerceSubscriptions\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-WCS.html"><abbr title="\WooCommerceSubscriptions\WCS">WCS</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-GatewaysPayPal.html"><abbr title="\WooCommerceSubscriptions\GatewaysPayPal">GatewaysPayPal</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-Privacy.html"><abbr title="\WooCommerceSubscriptions\Privacy">Privacy</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-SubscriptionsAPI.html"><abbr title="\WooCommerce\SubscriptionsAPI">SubscriptionsAPI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsIncludesEmails.html"><abbr title="\WooCommerce\SubscriptionsIncludesEmails">SubscriptionsIncludesEmails</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsClassesEmails.html"><abbr title="\WooCommerce\SubscriptionsClassesEmails">SubscriptionsClassesEmails</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WC.html"><abbr title="\WC">WC</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WC-Subscriptions.html"><abbr title="\WC\Subscriptions">Subscriptions</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminUpgrades.html"><abbr title="\WooCommerceSubscriptionsAdminUpgrades">WooCommerceSubscriptionsAdminUpgrades</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsFunctions.html"><abbr title="\WooCommerceSubscriptionsFunctions">WooCommerceSubscriptionsFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminMetaBoxes.html"><abbr title="\WooCommerceSubscriptionsAdminMetaBoxes">WooCommerceSubscriptionsAdminMetaBoxes</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAbstracts.html"><abbr title="\WooCommerceSubscriptionsAbstracts">WooCommerceSubscriptionsAbstracts</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsIncludes.html"><abbr title="\WooCommerceSubscriptionsIncludes">WooCommerceSubscriptionsIncludes</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceClassesEmails.html"><abbr title="\WooCommerceClassesEmails">WooCommerceClassesEmails</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/SkyVergeWooCommerceAPI.html"><abbr title="\SkyVergeWooCommerceAPI">SkyVergeWooCommerceAPI</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
            <li class="phpdocumentor-breadcrumb"><a href="../packages/WooCommerce.html">WooCommerce</a></li>
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wc-subscriptions-checkout.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * Subscriptions Checkout
 *
 * Extends the WooCommerce checkout class to add subscription meta on checkout.
 *
 * @package WooCommerce Subscriptions
 * @subpackage WC_Subscriptions_Checkout
 * @category Class
 * @author Brent Shepherd
 */
class WC_Subscriptions_Checkout {

	private static $guest_checkout_option_changed = false;

	/**
	 * Bootstraps the class and hooks required actions &amp; filters.
	 *
	 * @since 1.0
	 */
	public static function init() {

		// We need to create subscriptions on checkout and want to do it after almost all other extensions have added their products/items/fees
		add_action( &#039;woocommerce_checkout_order_processed&#039;, array( __CLASS__, &#039;process_checkout&#039; ), 100, 2 );

		// Same as above, but this is for the Checkout block.
		if ( class_exists( &#039;Automattic\WooCommerce\Blocks\Package&#039; ) &amp;&amp; ( version_compare( \Automattic\WooCommerce\Blocks\Package::get_version(), &#039;6.3.0&#039;, &#039;&gt;=&#039; ) || \Automattic\WooCommerce\Blocks\Package::is_experimental_build() ) ) {
			add_action( &#039;woocommerce_blocks_checkout_order_processed&#039;, array( __CLASS__, &#039;process_checkout&#039; ), 100, 1 );
		} else {
			add_action( &#039;__experimental_woocommerce_blocks_checkout_order_processed&#039;, array( __CLASS__, &#039;process_checkout&#039; ), 100, 1 );
		}

		// Some callbacks need to hooked after WC has loaded.
		add_action( &#039;woocommerce_loaded&#039;, array( __CLASS__, &#039;attach_dependant_hooks&#039; ) );

		// When a line item is added to a subscription on checkout, ensure the backorder data added by WC is removed
		add_action( &#039;woocommerce_checkout_create_order_line_item&#039;, array( __CLASS__, &#039;remove_backorder_meta_from_subscription_line_item&#039; ), 10, 4 );

		// When a line item is added to a subscription, ensure the __has_trial meta data is added if applicable.
		add_action( &#039;woocommerce_checkout_create_order_line_item&#039;, array( __CLASS__, &#039;maybe_add_free_trial_item_meta&#039; ), 10, 4 );

		// Store the amount of tax removed from a line item to account the base location&#039;s tax.
		add_action( &#039;woocommerce_checkout_create_order_line_item&#039;, array( __CLASS__, &#039;store_line_item_base_location_taxes&#039; ), 10, 3 );

		// Make sure user registration is required when purchasing subscriptions.
		add_filter( &#039;woocommerce_checkout_registration_required&#039;, array( __CLASS__, &#039;require_registration_during_checkout&#039; ) );
		add_action( &#039;woocommerce_before_checkout_process&#039;, array( __CLASS__, &#039;force_registration_during_checkout&#039; ), 10 );
		add_filter( &#039;woocommerce_checkout_registration_enabled&#039;, array( __CLASS__, &#039;maybe_enable_registration&#039; ) );

		// Override the WC default &quot;Add to cart&quot; text to &quot;Sign up now&quot; (in various places/templates)
		add_filter( &#039;woocommerce_order_button_text&#039;, array( __CLASS__, &#039;order_button_text&#039; ) );
	}

	/**
	 * @since 2.2.17
	 */
	public static function attach_dependant_hooks() {
		// Make sure guest checkout is not enabled in option param passed to WC JS
		if ( wcs_is_woocommerce_pre( &#039;3.3&#039; ) ) {
			add_filter( &#039;woocommerce_params&#039;, array( __CLASS__, &#039;filter_woocommerce_script_parameters&#039; ), 10, 1 );
			add_filter( &#039;wc_checkout_params&#039;, array( __CLASS__, &#039;filter_woocommerce_script_parameters&#039; ), 10, 1 );
		} else {
			add_filter( &#039;woocommerce_get_script_data&#039;, array( __CLASS__, &#039;filter_woocommerce_script_parameters&#039; ), 10, 2 );
		}
	}

	/**
	 * Create subscriptions purchased on checkout.
	 *
	 * @param int $order_id The post_id of a shop_order post/WC_Order object
	 * @param array $posted_data The data posted on checkout
	 * @since 2.0
	 */
	public static function process_checkout( $order_id, $posted_data = array() ) {

		if ( ! WC_Subscriptions_Cart::cart_contains_subscription() ) {
			return;
		}

		$order = wc_get_order( $order_id );

		$subscriptions = array();

		// First clear out any subscriptions created for a failed payment to give us a clean slate for creating new subscriptions
		$subscriptions = wcs_get_subscriptions_for_order( wcs_get_objects_property( $order, &#039;id&#039; ), array( &#039;order_type&#039; =&gt; &#039;parent&#039; ) );

		if ( ! empty( $subscriptions ) ) {
			remove_action( &#039;before_delete_post&#039;, &#039;WC_Subscriptions_Manager::maybe_cancel_subscription&#039; );
			foreach ( $subscriptions as $subscription ) {
				wp_delete_post( $subscription-&gt;get_id() );
			}
			add_action( &#039;before_delete_post&#039;, &#039;WC_Subscriptions_Manager::maybe_cancel_subscription&#039; );
		}

		WC_Subscriptions_Cart::set_global_recurring_shipping_packages();

		// Create new subscriptions for each group of subscription products in the cart (that is not a renewal)
		foreach ( WC()-&gt;cart-&gt;recurring_carts as $recurring_cart ) {

			$subscription = self::create_subscription( $order, $recurring_cart, $posted_data ); // Exceptions are caught by WooCommerce

			if ( is_wp_error( $subscription ) ) {
				throw new Exception( $subscription-&gt;get_error_message() );
			}

			do_action( &#039;woocommerce_checkout_subscription_created&#039;, $subscription, $order, $recurring_cart );
		}

		do_action( &#039;subscriptions_created_for_order&#039;, $order ); // Backward compatibility
	}

	/**
	 * Create a new subscription from a cart item on checkout.
	 *
	 * The function doesn&#039;t validate whether the cart item is a subscription product, meaning it can be used for any cart item,
	 * but the item will need a `subscription_period` and `subscription_period_interval` value set on it, at a minimum.
	 *
	 * @param WC_Order $order
	 * @param WC_Cart $cart
	 * @since 2.0
	 */
	public static function create_subscription( $order, $cart, $posted_data ) {

		try {
			// Start transaction if available
			$transaction = new WCS_SQL_Transaction();
			$transaction-&gt;start();

			// Set the recurring line totals on the subscription
			$variation_id = wcs_cart_pluck( $cart, &#039;variation_id&#039; );
			$product_id   = empty( $variation_id ) ? wcs_cart_pluck( $cart, &#039;product_id&#039; ) : $variation_id;

			$subscription = wcs_create_subscription(
				array(
					&#039;start_date&#039;       =&gt; $cart-&gt;start_date,
					&#039;order_id&#039;         =&gt; wcs_get_objects_property( $order, &#039;id&#039; ),
					&#039;customer_id&#039;      =&gt; $order-&gt;get_user_id(),
					&#039;billing_period&#039;   =&gt; wcs_cart_pluck( $cart, &#039;subscription_period&#039; ),
					&#039;billing_interval&#039; =&gt; wcs_cart_pluck( $cart, &#039;subscription_period_interval&#039; ),
					&#039;customer_note&#039;    =&gt; wcs_get_objects_property( $order, &#039;customer_note&#039; ),
				)
			);

			if ( is_wp_error( $subscription ) ) {
				// If the customer wasn&#039;t created on checkout and registration isn&#039;t enabled, display a more appropriate error message.
				if ( &#039;woocommerce_subscription_invalid_customer_id&#039; === $subscription-&gt;get_error_code() &amp;&amp; ! is_user_logged_in() &amp;&amp; ! WC()-&gt;checkout-&gt;is_registration_enabled() ) {
					throw new Exception( self::get_registration_error_message() );
				}

				throw new Exception( $subscription-&gt;get_error_message() );
			}

			// Set the subscription&#039;s billing and shipping address
			$subscription = wcs_copy_order_address( $order, $subscription );

			$subscription-&gt;update_dates(
				array(
					&#039;trial_end&#039;    =&gt; $cart-&gt;trial_end_date,
					&#039;next_payment&#039; =&gt; $cart-&gt;next_payment_date,
					&#039;end&#039;          =&gt; $cart-&gt;end_date,
				)
			);

			// Store trial period for PayPal
			if ( wcs_cart_pluck( $cart, &#039;subscription_trial_length&#039; ) &gt; 0 ) {
				$subscription-&gt;set_trial_period( wcs_cart_pluck( $cart, &#039;subscription_trial_period&#039; ) );
			}

			// Set the payment method on the subscription
			$available_gateways   = WC()-&gt;payment_gateways-&gt;get_available_payment_gateways();
			$order_payment_method = wcs_get_objects_property( $order, &#039;payment_method&#039; );

			if ( $cart-&gt;needs_payment() &amp;&amp; isset( $available_gateways[ $order_payment_method ] ) ) {
				$subscription-&gt;set_payment_method( $available_gateways[ $order_payment_method ] );
			}

			if ( ! $cart-&gt;needs_payment() || wcs_is_manual_renewal_required() ) {
				$subscription-&gt;set_requires_manual_renewal( true );
			} elseif ( ! isset( $available_gateways[ $order_payment_method ] ) || ! $available_gateways[ $order_payment_method ]-&gt;supports( &#039;subscriptions&#039; ) ) {
				$subscription-&gt;set_requires_manual_renewal( true );
			}

			wcs_copy_order_meta( $order, $subscription, &#039;subscription&#039; );

			// Store the line items
			if ( is_callable( array( WC()-&gt;checkout, &#039;create_order_line_items&#039; ) ) ) {
				WC()-&gt;checkout-&gt;create_order_line_items( $subscription, $cart );
			} else {
				foreach ( $cart-&gt;get_cart() as $cart_item_key =&gt; $cart_item ) {
					$item_id = self::add_cart_item( $subscription, $cart_item, $cart_item_key );
				}
			}

			// Store fees (although no fees recur by default, extensions may add them)
			if ( is_callable( array( WC()-&gt;checkout, &#039;create_order_fee_lines&#039; ) ) ) {
				WC()-&gt;checkout-&gt;create_order_fee_lines( $subscription, $cart );
			} else {
				foreach ( $cart-&gt;get_fees() as $fee_key =&gt; $fee ) {
					$item_id = $subscription-&gt;add_fee( $fee );

					if ( ! $item_id ) {
						// translators: placeholder is an internal error number
						throw new Exception( sprintf( __( &#039;Error %d: Unable to create subscription. Please try again.&#039;, &#039;woocommerce-subscriptions&#039; ), 403 ) );
					}

					// Allow plugins to add order item meta to fees
					do_action( &#039;woocommerce_add_order_fee_meta&#039;, $subscription-&gt;get_id(), $item_id, $fee, $fee_key );
				}
			}

			self::add_shipping( $subscription, $cart );

			// Store tax rows
			if ( is_callable( array( WC()-&gt;checkout, &#039;create_order_tax_lines&#039; ) ) ) {
				WC()-&gt;checkout-&gt;create_order_tax_lines( $subscription, $cart );
			} else {
				foreach ( array_keys( $cart-&gt;taxes + $cart-&gt;shipping_taxes ) as $tax_rate_id ) {
					if ( $tax_rate_id &amp;&amp; ! $subscription-&gt;add_tax( $tax_rate_id, $cart-&gt;get_tax_amount( $tax_rate_id ), $cart-&gt;get_shipping_tax_amount( $tax_rate_id ) ) &amp;&amp; apply_filters( &#039;woocommerce_cart_remove_taxes_zero_rate_id&#039;, &#039;zero-rated&#039; ) !== $tax_rate_id ) {
						// translators: placeholder is an internal error number
						throw new Exception( sprintf( __( &#039;Error %d: Unable to add tax to subscription. Please try again.&#039;, &#039;woocommerce-subscriptions&#039; ), 405 ) );
					}
				}
			}

			// Store coupons
			if ( is_callable( array( WC()-&gt;checkout, &#039;create_order_coupon_lines&#039; ) ) ) {
				WC()-&gt;checkout-&gt;create_order_coupon_lines( $subscription, $cart );
			} else {
				foreach ( $cart-&gt;get_coupons() as $code =&gt; $coupon ) {
					if ( ! $subscription-&gt;add_coupon( $code, $cart-&gt;get_coupon_discount_amount( $code ), $cart-&gt;get_coupon_discount_tax_amount( $code ) ) ) {
						// translators: placeholder is an internal error number
						throw new Exception( sprintf( __( &#039;Error %d: Unable to create order. Please try again.&#039;, &#039;woocommerce-subscriptions&#039; ), 406 ) );
					}
				}
			}

			// Set the recurring totals on the subscription
			$subscription-&gt;set_shipping_total( $cart-&gt;shipping_total );
			$subscription-&gt;set_discount_total( $cart-&gt;get_cart_discount_total() );
			$subscription-&gt;set_discount_tax( $cart-&gt;get_cart_discount_tax_total() );
			$subscription-&gt;set_cart_tax( $cart-&gt;tax_total );
			$subscription-&gt;set_shipping_tax( $cart-&gt;shipping_tax_total );
			$subscription-&gt;set_total( $cart-&gt;total );

			// Hook to adjust subscriptions before saving with WC 3.0+ (matches WC 3.0&#039;s new &#039;woocommerce_checkout_create_order&#039; hook)
			do_action( &#039;woocommerce_checkout_create_subscription&#039;, $subscription, $posted_data, $order, $cart );

			// Save the subscription if using WC 3.0 &amp; CRUD
			$subscription-&gt;save();

			// If we got here, the subscription was created without problems
			$transaction-&gt;commit();

		} catch ( Exception $e ) {
			// There was an error adding the subscription
			$transaction-&gt;rollback();
			return new WP_Error( &#039;checkout-error&#039;, $e-&gt;getMessage() );
		}

		return $subscription;
	}


	/**
	 * Stores shipping info on the subscription
	 *
	 * @param WC_Subscription $subscription instance of a subscriptions object
	 * @param WC_Cart $cart A cart with recurring items in it
	 */
	public static function add_shipping( $subscription, $cart ) {

		// We need to make sure we only get recurring shipping packages
		WC_Subscriptions_Cart::set_calculation_type( &#039;recurring_total&#039; );
		WC_Subscriptions_Cart::set_recurring_cart_key( $cart-&gt;recurring_cart_key );

		if ( $cart-&gt;needs_shipping() ) {
			foreach ( $cart-&gt;get_shipping_packages() as $recurring_cart_package_key =&gt; $recurring_cart_package ) {
				$package_index      = isset( $recurring_cart_package[&#039;package_index&#039;] ) ? $recurring_cart_package[&#039;package_index&#039;] : 0;
				$package            = WC_Subscriptions_Cart::get_calculated_shipping_for_package( $recurring_cart_package );
				$shipping_method_id = isset( WC()-&gt;checkout()-&gt;shipping_methods[ $package_index ] ) ? WC()-&gt;checkout()-&gt;shipping_methods[ $package_index ] : &#039;&#039;;

				if ( isset( WC()-&gt;checkout()-&gt;shipping_methods[ $recurring_cart_package_key ] ) ) {
					$shipping_method_id = WC()-&gt;checkout()-&gt;shipping_methods[ $recurring_cart_package_key ];
					$package_key        = $recurring_cart_package_key;
				} else {
					$package_key = $package_index;
				}

				if ( isset( $package[&#039;rates&#039;][ $shipping_method_id ] ) ) {
					$shipping_rate            = $package[&#039;rates&#039;][ $shipping_method_id ];
					$item                     = new WC_Order_Item_Shipping();
					$item-&gt;legacy_package_key = $package_key; // @deprecated For legacy actions.
					$item-&gt;set_props(
						array(
							&#039;method_title&#039; =&gt; $shipping_rate-&gt;label,
							&#039;total&#039;        =&gt; wc_format_decimal( $shipping_rate-&gt;cost ),
							&#039;taxes&#039;        =&gt; array( &#039;total&#039; =&gt; $shipping_rate-&gt;taxes ),
							&#039;order_id&#039;     =&gt; $subscription-&gt;get_id(),
						)
					);

					// Backwards compatibility for sites running WC pre 3.4 which stored shipping method and instance ID in a single meta row.
					if ( wcs_is_woocommerce_pre( &#039;3.4&#039; ) ) {
						$item-&gt;set_method_id( $shipping_rate-&gt;id );
					} else {
						$item-&gt;set_method_id( $shipping_rate-&gt;method_id );
						$item-&gt;set_instance_id( $shipping_rate-&gt;instance_id );
					}

					foreach ( $shipping_rate-&gt;get_meta_data() as $key =&gt; $value ) {
						$item-&gt;add_meta_data( $key, $value, true );
					}

					$subscription-&gt;add_item( $item );

					$item-&gt;save(); // We need the item ID for old hooks, this can be removed once support for WC &lt; 3.0 is dropped
					wc_do_deprecated_action( &#039;woocommerce_subscriptions_add_recurring_shipping_order_item&#039;, array( $subscription-&gt;get_id(), $item-&gt;get_id(), $package_key ), &#039;2.2.0&#039;, &#039;CRUD and woocommerce_checkout_create_subscription_shipping_item action instead&#039; );

					do_action( &#039;woocommerce_checkout_create_order_shipping_item&#039;, $item, $package_key, $package, $subscription ); // WC 3.0+ will also trigger the deprecated &#039;woocommerce_add_shipping_order_item&#039; hook
					do_action( &#039;woocommerce_checkout_create_subscription_shipping_item&#039;, $item, $package_key, $package, $subscription );
				}
			}
		}

		WC_Subscriptions_Cart::set_calculation_type( &#039;none&#039; );
		WC_Subscriptions_Cart::set_recurring_cart_key( &#039;none&#039; );
	}

	/**
	 * Remove the Backordered meta data from subscription line items added on the checkout.
	 *
	 * @param WC_Order_Item_Product $order_item
	 * @param string $cart_item_key The hash used to identify the item in the cart
	 * @param array $cart_item The cart item&#039;s data.
	 * @param WC_Order|WC_Subscription $subscription The order or subscription object to which the line item relates
	 * @since 2.2.0
	 */
	public static function remove_backorder_meta_from_subscription_line_item( $item, $cart_item_key, $cart_item, $subscription ) {

		if ( wcs_is_subscription( $subscription ) ) {
			$item-&gt;delete_meta_data( apply_filters( &#039;woocommerce_backordered_item_meta_name&#039;, __( &#039;Backordered&#039;, &#039;woocommerce-subscriptions&#039; ) ) );
		}
	}

	/**
	 * Set a flag in subscription line item meta if the line item has a free trial.
	 *
	 * @param WC_Order_Item_Product $item The item being added to the subscription.
	 * @param string $cart_item_key The item&#039;s cart item key.
	 * @param array $cart_item The cart item.
	 * @param WC_Subscription $subscription The subscription the item is being added to.
	 * @since 2.6.0
	 */
	public static function maybe_add_free_trial_item_meta( $item, $cart_item_key, $cart_item, $subscription ) {
		if ( wcs_is_subscription( $subscription ) &amp;&amp; WC_Subscriptions_Product::get_trial_length( $item-&gt;get_product() ) &gt; 0 ) {
			$item-&gt;update_meta_data( &#039;_has_trial&#039;, &#039;true&#039; );
		}
	}

	/**
	 * Add a cart item to a subscription.
	 *
	 * @since 2.0
	 */
	public static function add_cart_item( $subscription, $cart_item, $cart_item_key ) {
		_deprecated_function( __METHOD__, &#039;2.2.0&#039;, &#039;WC_Checkout::create_order_line_items( $subscription, $cart )&#039; );

		$item_id = $subscription-&gt;add_product(
			$cart_item[&#039;data&#039;],
			$cart_item[&#039;quantity&#039;],
			array(
				&#039;variation&#039; =&gt; $cart_item[&#039;variation&#039;],
				&#039;totals&#039;    =&gt; array(
					&#039;subtotal&#039;     =&gt; $cart_item[&#039;line_subtotal&#039;],
					&#039;subtotal_tax&#039; =&gt; $cart_item[&#039;line_subtotal_tax&#039;],
					&#039;total&#039;        =&gt; $cart_item[&#039;line_total&#039;],
					&#039;tax&#039;          =&gt; $cart_item[&#039;line_tax&#039;],
					&#039;tax_data&#039;     =&gt; $cart_item[&#039;line_tax_data&#039;],
				),
			)
		);

		if ( ! $item_id ) {
			// translators: placeholder is an internal error number
			throw new Exception( sprintf( __( &#039;Error %d: Unable to create subscription. Please try again.&#039;, &#039;woocommerce-subscriptions&#039; ), 402 ) );
		}

		$cart_item_product_id = ( 0 != $cart_item[&#039;variation_id&#039;] ) ? $cart_item[&#039;variation_id&#039;] : $cart_item[&#039;product_id&#039;];

		if ( WC_Subscriptions_Product::get_trial_length( wcs_get_canonical_product_id( $cart_item ) ) &gt; 0 ) {
			wc_add_order_item_meta( $item_id, &#039;_has_trial&#039;, &#039;true&#039; );
		}

		// Allow plugins to add order item meta
		wc_do_deprecated_action( &#039;woocommerce_add_order_item_meta&#039;, array( $item_id, $cart_item, $cart_item_key ), &#039;3.0&#039;, &#039;CRUD and woocommerce_checkout_create_order_line_item action instead&#039; );
		wc_do_deprecated_action( &#039;woocommerce_add_subscription_item_meta&#039;, array( $item_id, $cart_item, $cart_item_key ), &#039;3.0&#039;, &#039;CRUD and woocommerce_checkout_create_order_line_item action instead&#039; );

		return $item_id;
	}

	/**
	 * When a new order is inserted, add subscriptions related order meta.
	 *
	 * @since 1.0
	 */
	public static function add_order_meta( $order_id, $posted ) {
		_deprecated_function( __METHOD__, &#039;2.0&#039; );
	}

	/**
	 * Add each subscription product&#039;s details to an order so that the state of the subscription persists even when a product is changed
	 *
	 * @since 1.2.5
	 */
	public static function add_order_item_meta( $item_id, $values ) {
		_deprecated_function( __METHOD__, &#039;2.0&#039; );
	}

	/**
	 * Also make sure the guest checkout option value passed to the woocommerce.js forces registration.
	 * Otherwise the registration form is hidden by woocommerce.js.
	 *
	 * @param string $handle Default empty string (&#039;&#039;).
	 * @param array  $woocommerce_params
	 *
	 * @since 2.5.3
	 * @return array
	 */
	public static function filter_woocommerce_script_parameters( $woocommerce_params, $handle = &#039;&#039; ) {
		// WC 3.3+ deprecates handle-specific filters in favor of &#039;woocommerce_get_script_data&#039;.
		if ( &#039;woocommerce_get_script_data&#039; === current_filter() &amp;&amp; ! in_array( $handle, array( &#039;woocommerce&#039;, &#039;wc-checkout&#039; ) ) ) {
			return $woocommerce_params;
		}

		if ( WC_Subscriptions_Cart::cart_contains_subscription() &amp;&amp; ! is_user_logged_in() &amp;&amp; isset( $woocommerce_params[&#039;option_guest_checkout&#039;] ) &amp;&amp; &#039;yes&#039; == $woocommerce_params[&#039;option_guest_checkout&#039;] ) {
			$woocommerce_params[&#039;option_guest_checkout&#039;] = &#039;no&#039;;
		}

		return $woocommerce_params;
	}

	/**
	 * Stores the subtracted base location tax totals in the subscription line item meta.
	 *
	 * @since 3.0.10
	 *
	 * @param WC_Line_Item_Product $line_item     The line item added to the order/subscription.
	 * @param string               $cart_item_key The key of the cart item being added to the cart.
	 * @param array                $cart_item     The cart item data.
	 */
	public static function store_line_item_base_location_taxes( $line_item, $cart_item_key, $cart_item ) {
		if ( isset( $cart_item[&#039;_subtracted_base_location_taxes&#039;] ) ) {
			$line_item-&gt;add_meta_data( &#039;_subtracted_base_location_taxes&#039;, $cart_item[&#039;_subtracted_base_location_taxes&#039;] );
			$line_item-&gt;add_meta_data( &#039;_subtracted_base_location_rates&#039;, $cart_item[&#039;_subtracted_base_location_rates&#039;] );
		}
	}

	/**
	 * Also make sure the guest checkout option value passed to the woocommerce.js forces registration.
	 * Otherwise the registration form is hidden by woocommerce.js.
	 *
	 * @since      1.1
	 * @deprecated 2.5.3
	 */
	public static function filter_woocommerce_script_paramaters( $woocommerce_params, $handle = &#039;&#039; ) {
		wcs_deprecated_function( __METHOD__, &#039;2.5.3&#039;, &#039;WC_Subscriptions_Admin::filter_woocommerce_script_parameters( $woocommerce_params, $handle )&#039; );

		return self::filter_woocommerce_script_parameters( $woocommerce_params, $handle );
	}

	/**
	 * Enables the &#039;registeration required&#039; (guest checkout) setting when purchasing subscriptions.
	 *
	 * @since 3.1.0
	 *
	 * @param bool $account_required Whether an account is required to checkout.
	 * @return bool
	 */
	public static function require_registration_during_checkout( $account_required ) {
		if ( WC_Subscriptions_Cart::cart_contains_subscription() &amp;&amp; ! is_user_logged_in() ) {
			$account_required = true;
		}

		return $account_required;
	}

	/**
	 * During the checkout process, force registration when the cart contains a subscription.
	 *
	 * @since 1.1
	 * @param $woocommerce_params This parameter is not used.
	 */
	public static function force_registration_during_checkout( $woocommerce_params ) {
		if ( WC_Subscriptions_Cart::cart_contains_subscription() &amp;&amp; ! is_user_logged_in() ) {
			$_POST[&#039;createaccount&#039;] = 1;
		}
	}

	/**
	 * Generates a registration failed error message depending on the store&#039;s registration settings.
	 *
	 * When a customer wasn&#039;t created on checkout because checkout registration is disabled,
	 * this function generates the error message displayed to the customer.
	 *
	 * The message will redirect the customer to the My Account page if registration is enabled there, otherwise a generic &#039;you need an account&#039; message will be displayed.
	 *
	 * @since 3.0.11
	 * @return string The error message.
	 */
	private static function get_registration_error_message() {
		// Direct the customer to login/register on the my account page if that&#039;s enabled.
		if ( &#039;yes&#039; === get_option( &#039;woocommerce_enable_myaccount_registration&#039; ) ) {
			// Translators: Placeholders are opening and closing strong and link tags.
			$message = __( &#039;Purchasing a subscription product requires an account. Please go to the %1$sMy Account%2$s page to login or register.&#039;, &#039;woocommerce-subscriptions&#039; );
		} else {
			// Translators: Placeholders are opening and closing strong and link tags.
			$message = __( &#039;Purchasing a subscription product requires an account. Please go to the %1$sMy Account%2$s page to login or contact us if you need assistance.&#039;, &#039;woocommerce-subscriptions&#039; );
		}

		return sprintf( $message, &#039;&lt;strong&gt;&lt;a href=&quot;&#039; . wc_get_page_permalink( &#039;myaccount&#039; ) . &#039;&quot;&gt;&#039;, &#039;&lt;/a&gt;&lt;/strong&gt;&#039; );
	}

	/**
	 * Enables registration for carts containing subscriptions if admin allow it.
	 *
	 * @since 3.1.0
	 *
	 * @param  bool $registration_enabled Whether registration is enabled on checkout by default.
	 * @return bool
	 */
	public static function maybe_enable_registration( $registration_enabled ) {
		// Exit early if regristration is already allowed.
		if ( $registration_enabled ) {
			return $registration_enabled;
		}

		if ( is_user_logged_in() || ! WC_Subscriptions_Cart::cart_contains_subscription() ) {
			return $registration_enabled;
		}

		if ( apply_filters( &#039;wc_is_registration_enabled_for_subscription_purchases&#039;, &#039;yes&#039; === get_option( &#039;woocommerce_enable_signup_from_checkout_for_subscriptions&#039;, &#039;yes&#039; ) ) ) {
			$registration_enabled = true;
		}

		return $registration_enabled;
	}

	/**
	 * When creating an order at checkout, if the checkout is to renew a subscription from a failed
	 * payment, hijack the order creation to make a renewal order - not a plain WooCommerce order.
	 *
	 * @since 1.3
	 * @deprecated 2.0
	 */
	public static function filter_woocommerce_create_order( $order_id, $checkout_object ) {
		_deprecated_function( __METHOD__, &#039;2.0&#039; );
		return $order_id;
	}

	/**
	 * Customise which actions are shown against a subscriptions order on the My Account page.
	 *
	 * @since 1.3
	 */
	public static function filter_woocommerce_my_account_my_orders_actions( $actions, $order ) {
		_deprecated_function( __METHOD__, &#039;2.0&#039;, &#039;WCS_Cart_Renewal::filter_my_account_my_orders_actions()&#039; );
		return $actions;
	}

	/**
	 * If shopping cart contains subscriptions, make sure a user can register on the checkout page
	 *
	 * @since 1.0
	 * @deprecated 3.1.0
	 */
	public static function make_checkout_registration_possible( $checkout = &#039;&#039; ) {
		wcs_deprecated_function( __METHOD__, &#039;3.1.0&#039; );
		if ( WC_Subscriptions_Cart::cart_contains_subscription() &amp;&amp; ! is_user_logged_in() ) {

			// Make sure users are required to register an account
			if ( true === $checkout-&gt;enable_guest_checkout ) {
				$checkout-&gt;enable_guest_checkout     = false;
				self::$guest_checkout_option_changed = true;

				$checkout-&gt;must_create_account = true;
			}
		}
	}

	/**
	 * Make sure account fields display the required &quot;*&quot; when they are required.
	 *
	 * @since 1.3.5
	 * @deprecated 3.1.0
	 */
	public static function make_checkout_account_fields_required( $checkout_fields ) {
		wcs_deprecated_function( __METHOD__, &#039;3.1.0&#039; );
		if ( WC_Subscriptions_Cart::cart_contains_subscription() &amp;&amp; ! is_user_logged_in() ) {

			$account_fields = array(
				&#039;account_username&#039;,
				&#039;account_password&#039;,
				&#039;account_password-2&#039;,
			);

			foreach ( $account_fields as $account_field ) {
				if ( isset( $checkout_fields[&#039;account&#039;][ $account_field ] ) ) {
					$checkout_fields[&#039;account&#039;][ $account_field ][&#039;required&#039;] = true;
				}
			}
		}

		return $checkout_fields;
	}

	/**
	 * After displaying the checkout form, restore the store&#039;s original registration settings.
	 *
	 * @since 1.1
	 * @deprecated 3.1.0
	 */
	public static function restore_checkout_registration_settings( $checkout = &#039;&#039; ) {
		wcs_deprecated_function( __METHOD__, &#039;3.1.0&#039; );
		if ( self::$guest_checkout_option_changed ) {
			$checkout-&gt;enable_guest_checkout = true;
			if ( ! is_user_logged_in() ) { // Also changed must_create_account
				$checkout-&gt;must_create_account = false;
			}
		}
	}

	/**
	 * Overrides the &quot;Place order&quot; button text with &quot;Sign up now&quot; when the cart contains initial subscription purchases.
	 *
	 * @since 4.0.0
	 *
	 * @param string  $button_text The place order button text.
	 * @return string $button_text
	 */
	public static function order_button_text( $button_text ) {
		if ( ! WC_Subscriptions_Cart::cart_contains_subscription() ) {
			return $button_text;
		}

		// Return the default button text if the cart contains a Subscription order type. The button text for these carts is filtered separately.
		if ( wcs_cart_contains_renewal() || wcs_cart_contains_resubscribe() || wcs_cart_contains_switches() ) {
			return $button_text;
		}

		return apply_filters( &#039;wcs_place_subscription_order_text&#039;, __( &#039;Sign up now&#039;, &#039;woocommerce-subscriptions&#039; ) );
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on September 21st, 2022 at 05:39 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1663738776"></script>
    <script src="../js/search.js?updated=1663738776"></script>
</body>
</html>
