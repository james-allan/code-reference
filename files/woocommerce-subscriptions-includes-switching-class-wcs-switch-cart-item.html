<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>WooCommerce Code Reference</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="../images/favicon.png" />
    <link rel="apple-touch-icon" href="../images/apple-touch-icon.png"/>
    <link rel="apple-touch-icon" sizes="72x72" href="../images/apple-touch-icon-72x72.png"/>
    <link rel="apple-touch-icon" sizes="114x114" href="../images/apple-touch-icon-114x114.png"/>
    <link rel="stylesheet" href="../css/normalize.css">
    <link rel="stylesheet" href="../css/base.css?updated=1663659953">
    <link href="https://fonts.googleapis.com/css2?family=Source+Sans+Pro:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/template.css?updated=1663659953">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/css/all.min.css" integrity="sha256-ybRkN9dBjhcS2qrW1z+hfCxq+1aBdwyQM5wlQoQVt/0=" crossorigin="anonymous" />
            <script src="https://cdn.jsdelivr.net/npm/css-vars-ponyfill@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.0/js/all.min.js" integrity="sha256-0vuk8LXoyrmCjp1f0O300qo1M75ZQyhH9X3J6d+scmk=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tarekraafat/autocomplete.js@7.2.0/dist/js/autoComplete.min.js"></script>
    <!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-8KCYZ2CYMS"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-8KCYZ2CYMS', {
		'content_group' : 'WooCommerce Core Code Reference',
	});
</script>
        <script src="../js/prism.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            window.dispatchEvent(new HashChangeEvent('hashchange'));
        });
    </script>
</head>
<body id="top">
    <header class="phpdocumentor-top-header">
    <section class="phpdocumentor-section">
        <div class="site-branding">
            <a class="site-logo" href="../index.html"><img width="180" src="../images/logo.svg" alt="WooCommerce" /></a>
        </div>
        <nav class="main-navigation">
            <ul>
                <li><a href="../hooks/hooks.html">Hooks Reference</a></li>
                <li><a href="https://docs.woocommerce.com/">Documentation</a></li>
                <li><a href="https://woocommerce.github.io/woocommerce-rest-api-docs/">REST API Docs</a></li>
                <li><a href="https://woocommerce.com/careers/?utm_source=woocommerce+core+code+reference&utm_medium=devdocs&utm_campaign=woo+careers" target="_blank">We're hiring!</a></li>
            </ul>
        </nav>
    </section>
</header>

<div class="phpdocumentor-header">
    <section class="phpdocumentor-section">
        <h1 class="phpdocumentor-title">WooCommerce Code Reference</h1>
        <section class="phpdocumentor-search">
    <label class="phpdocumentor-label">
        <span class="visually-hidden">Search (click ESC to close search results)</span>
        <input id="autoComplete" tabindex="1" type="search" class="phpdocumentor-field phpdocumentor-search__field" placeholder="Loading..." disabled />
    </label>
</section>

    </section>
</div>

    <main class="phpdocumentor">
        <div class="phpdocumentor-section">
            <aside class="phpdocumentor-column -four phpdocumentor-sidebar">
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Namespaces</h2>
            </section>

        <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Packages</h2>
                    <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdmin.html"><abbr title="\WooCommerceSubscriptionsAdmin">WooCommerceSubscriptionsAdmin</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsClasses.html"><abbr title="\WooCommerceSubscriptionsClasses">WooCommerceSubscriptionsClasses</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptions.html"><abbr title="\WooCommerceSubscriptions">WooCommerceSubscriptions</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerceSubscriptions-WC.html"><abbr title="\WooCommerceSubscriptions\WC">WC</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-RestApi.html"><abbr title="\WooCommerceSubscriptions\RestApi">RestApi</abbr></a></li>
                                    <li><a href="../packages/WooCommerceSubscriptions-WCS.html"><abbr title="\WooCommerceSubscriptions\WCS">WCS</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerce.html"><abbr title="\WooCommerce">WooCommerce</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WooCommerce-SubscriptionsAPI.html"><abbr title="\WooCommerce\SubscriptionsAPI">SubscriptionsAPI</abbr></a></li>
                                    <li><a href="../packages/WooCommerce-SubscriptionsIncludesEmails.html"><abbr title="\WooCommerce\SubscriptionsIncludesEmails">SubscriptionsIncludesEmails</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WC.html"><abbr title="\WC">WC</abbr></a></h3>
                        <ul class="phpdocumentor-list">
                                    <li><a href="../packages/WC-Subscriptions.html"><abbr title="\WC\Subscriptions">Subscriptions</abbr></a></li>
                            </ul>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminUpgrades.html"><abbr title="\WooCommerceSubscriptionsAdminUpgrades">WooCommerceSubscriptionsAdminUpgrades</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsFunctions.html"><abbr title="\WooCommerceSubscriptionsFunctions">WooCommerceSubscriptionsFunctions</abbr></a></h3>
                                <h3 class="phpdocumentor-sidebar__root-package"><a href="../packages/WooCommerceSubscriptionsAdminMetaBoxes.html"><abbr title="\WooCommerceSubscriptionsAdminMetaBoxes">WooCommerceSubscriptionsAdminMetaBoxes</abbr></a></h3>
                        </section>
    
    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Reports</h2>
                <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/deprecated.html">Deprecated</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/errors.html">Errors</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../reports/markers.html">Markers</a></h3>
    </section>

    <section class="phpdocumentor-sidebar__category">
        <h2 class="phpdocumentor-sidebar__category-header">Indices</h2>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../indices/files.html">Files</a></h3>
        <h3 class="phpdocumentor-sidebar__root-package"><a href="../hooks/hooks.html">Hooks Reference</a></h3>
    </section>
</aside>

            <div class="phpdocumentor-column -eight phpdocumentor-content">
                    <ul class="phpdocumentor-breadcrumbs">
            <li class="phpdocumentor-breadcrumb"><a href="../packages/WooCommerce.html">WooCommerce</a></li>
    </ul>

    <article class="phpdocumentor-element -file">
        <h2 class="phpdocumentor-content__title">class-wcs-switch-cart-item.php</h2>

                

        
                    <h3 class="phpdocumentor-elements__header" id="source-code">
                Source code
                <a href="#source-code" class="headerlink"><i class="fas fa-link"></i></a>
            </h3>
            <pre id="source-view" tabindex="-1" class="language-php line-numbers linkable-line-numbers"><code>&lt;?php
/**
 * WooCommerce Subscriptions Switch Cart Item.
 *
 * A class to assist in the calculations required to record a switch.
 *
 * @package WooCommerce Subscriptions
 * @author  Prospress
 * @since   2.6.0
 */
class WCS_Switch_Cart_Item {

	/**
	 * The cart item.
	 * @var array
	 */
	public $cart_item;

	/**
	 * The subscription being switched.
	 * @var WC_Subscription
	 */
	public $subscription;

	/**
	 * The existing subscription line item being switched.
	 * @var WC_Order_Item_Product
	 */
	public $existing_item;

	/**
	 * The instance of the new product in the cart.
	 * @var WC_Product
	 */
	public $product;

	/**
	 * The new product&#039;s variation or product ID.
	 * @var int
	 */
	public $canonical_product_id;

	/**
	 * The subscription&#039;s next payment timestamp.
	 * @var int
	 */
	public $next_payment_timestamp;

	/**
	 * The subscription&#039;s end timestamp.
	 * @var int
	 */
	public $end_timestamp;

	/**
	 * The subscription&#039;s last non-early renewal or parent order paid timestamp.
	 * @var int
	 */
	public $last_order_paid_time;

	/**
	 * The number of days since the @see $last_order_created_time.
	 * @var int
	 */
	public $days_since_last_payment;

	/**
	 * The number of days until the @see $next_payment_timestamp.
	 * @var int
	 */
	public $days_until_next_payment;

	/**
	 * The number of days in the old subscription&#039;s billing cycle.
	 * @var int
	 */
	public $days_in_old_cycle;

	/**
	 * The total paid for the existing item (@see $existing_item) in early renewals and switch orders since the last non-early renewal or parent order.
	 * @var float
	 */
	public $total_paid_for_current_period;

	/**
	 * The existing subscription item&#039;s price per day.
	 * @var float
	 */
	public $old_price_per_day;

	/**
	 * The number of days in the new subscription&#039;s billing cycle.
	 * @var float
	 */
	public $days_in_new_cycle;

	/**
	 * The new subscription product&#039;s price per day.
	 * @var float
	 */
	public $new_price_per_day;

	/**
	 * The switch type.
	 * @var string Can be upgrade, downgrade or crossgrade.
	 */
	public $switch_type;

	/**
	 * Constructor.
	 *
	 * @since 2.6.0
	 *
	 * @param array $cart_item                     The cart item.
	 * @param WC_Subscription $subscription        The subscription being switched.
	 * @param WC_Order_Item_Product $existing_item The subscription line item being switched.
	 *
	 * @throws Exception If WC_Subscriptions_Product::get_expiration_date() returns an invalid date.
	 */
	public function __construct( $cart_item, $subscription, $existing_item ) {
		$this-&gt;cart_item               = $cart_item;
		$this-&gt;subscription            = $subscription;
		$this-&gt;existing_item           = $existing_item;
		$this-&gt;canonical_product_id    = wcs_get_canonical_product_id( $cart_item );
		$this-&gt;product                 = $cart_item[&#039;data&#039;];
		$this-&gt;next_payment_timestamp  = $cart_item[&#039;subscription_switch&#039;][&#039;next_payment_timestamp&#039;];
		$this-&gt;end_timestamp           = wcs_date_to_time( WC_Subscriptions_Product::get_expiration_date( $this-&gt;canonical_product_id, $this-&gt;subscription-&gt;get_date( &#039;last_order_date_created&#039; ) ) );
	}

	/** Getters */

	/**
	 * Gets the number of days until the next payment.
	 *
	 * @since 2.6.0
	 * @return int
	 */
	public function get_days_until_next_payment() {
		if ( ! isset( $this-&gt;days_until_next_payment ) ) {
			$this-&gt;days_until_next_payment = ceil( ( $this-&gt;next_payment_timestamp - gmdate( &#039;U&#039; ) ) / DAY_IN_SECONDS );
		}

		return $this-&gt;days_until_next_payment;
	}

	/**
	 * Gets the number of days in the old billing cycle.
	 *
	 * @since 2.6.0
	 * @return int
	 */
	public function get_days_in_old_cycle() {
		if ( ! isset( $this-&gt;days_in_old_cycle ) ) {
			$this-&gt;days_in_old_cycle = $this-&gt;calculate_days_in_old_cycle();
		}

		return $this-&gt;days_in_old_cycle;
	}

	/**
	 * Gets the old subscription&#039;s price per day.
	 *
	 * @since 2.6.0
	 * @return float
	 */
	public function get_old_price_per_day() {
		if ( ! isset( $this-&gt;old_price_per_day ) ) {
			$days_in_old_cycle = $this-&gt;get_days_in_old_cycle();

			$total_paid_for_current_period = $this-&gt;get_total_paid_for_current_period();

			$old_price_per_day       = $days_in_old_cycle &gt; 0 ? $total_paid_for_current_period / $days_in_old_cycle : $total_paid_for_current_period;
			$this-&gt;old_price_per_day = apply_filters( &#039;wcs_switch_proration_old_price_per_day&#039;, $old_price_per_day, $this-&gt;subscription, $this-&gt;cart_item, $total_paid_for_current_period, $days_in_old_cycle );
		}

		return $this-&gt;old_price_per_day;
	}

	/**
	 * Gets the number of days in the new billing cycle.
	 *
	 * @since 2.6.0
	 * @return int
	 */
	public function get_days_in_new_cycle() {
		if ( ! isset( $this-&gt;days_in_new_cycle ) ) {
			$this-&gt;days_in_new_cycle = $this-&gt;calculate_days_in_new_cycle();
		}

		return $this-&gt;days_in_new_cycle;
	}

	/**
	 * Gets the number of days in the new billing cycle.
	 *
	 * @since 2.6.0
	 * @return float
	 */
	public function get_new_price_per_day() {
		if ( ! isset( $this-&gt;new_price_per_day ) ) {
			$days_in_new_cycle = $this-&gt;get_days_in_new_cycle();

			if ( $this-&gt;is_switch_during_trial() &amp;&amp; $this-&gt;trial_periods_match() ) {
				$new_price_per_day = 0;
			} else {
				// We need to use the cart items price to ensure we include extras added by extensions like Product Add-ons, but we don&#039;t want the sign-up fee accounted for in the price, so make sure WC_Subscriptions_Cart::set_subscription_prices_for_calculation() isn&#039;t adding that.
				remove_filter( &#039;woocommerce_product_get_price&#039;, &#039;WC_Subscriptions_Cart::set_subscription_prices_for_calculation&#039;, 100 );
				$new_price_per_day = ( WC_Subscriptions_Product::get_price( $this-&gt;product ) * $this-&gt;cart_item[&#039;quantity&#039;] ) / $days_in_new_cycle;
				add_filter( &#039;woocommerce_product_get_price&#039;, &#039;WC_Subscriptions_Cart::set_subscription_prices_for_calculation&#039;, 100, 2 );
			}

			$this-&gt;new_price_per_day = apply_filters( &#039;wcs_switch_proration_new_price_per_day&#039;, $new_price_per_day, $this-&gt;subscription, $this-&gt;cart_item, $days_in_new_cycle );
		}

		return $this-&gt;new_price_per_day;
	}

	/**
	 * Gets the subscription&#039;s last order paid time.
	 *
	 * @since 2.6.0
	 * @return int The paid timestamp of the subscription&#039;s last non-early renewal or parent order. If none of those are present, the subscription&#039;s start time will be returned.
	 */
	public function get_last_order_paid_time() {
		if ( ! isset( $this-&gt;last_order_paid_time ) ) {
			$last_order = wcs_get_last_non_early_renewal_order( $this-&gt;subscription );

			// If there haven&#039;t been any non-early renewals yet, use the parent
			if ( ! $last_order ) {
				$last_order = $this-&gt;subscription-&gt;get_parent();
			}

			// If there aren&#039;t any renewals or a parent order, use the subscription&#039;s created date.
			if ( ! $last_order ) {
				$this-&gt;last_order_paid_time = $this-&gt;subscription-&gt;get_time( &#039;start&#039; );
			} else {
				$order_date = $last_order-&gt;get_date_paid();

				// If the order hasn&#039;t been paid, use the created date. This shouldn&#039;t occur because only active (paid) subscriptions can be switched. However, we provide a fallback just in case.
				if ( ! $order_date ) {
					$order_date = $last_order-&gt;get_date_created();
				}

				$this-&gt;last_order_paid_time = $order_date-&gt;getTimestamp();
			}
		}

		return $this-&gt;last_order_paid_time;
	}

	/**
	 * Gets the total paid for the existing item (@see $this-&gt;existing_item) in early renewals and switch orders since the last non-early renewal or parent order.
	 *
	 * @since 2.6.0
	 * @return float
	 */
	public function get_total_paid_for_current_period() {

		if ( ! isset( $this-&gt;total_paid_for_current_period ) ) {
			// If the last order was a switch with a fully reduced pre-paid term, the amount the cutomer has paid is just the total in that order.
			if ( $this-&gt;is_switch_after_fully_reduced_prepaid_term() ) {
				$this-&gt;total_paid_for_current_period = WC_Subscriptions_Switcher::calculate_total_paid_since_last_order( $this-&gt;subscription, $this-&gt;existing_item, &#039;exclude_sign_up_fees&#039;, array( $this-&gt;get_last_switch_order() ) );
			} else {
				$this-&gt;total_paid_for_current_period = WC_Subscriptions_Switcher::calculate_total_paid_since_last_order( $this-&gt;subscription, $this-&gt;existing_item, &#039;exclude_sign_up_fees&#039; );
			}
		}

		return $this-&gt;total_paid_for_current_period;
	}

	/**
	 * Gets the number of days since the last payment.
	 *
	 * @since 2.6.0
	 * @return int The number of days since the last non-early renewal or parent payment - rounded down.
	 */
	public function get_days_since_last_payment() {
		if ( ! isset( $this-&gt;days_since_last_payment ) ) {
			// Use the timestamp for the last non-early renewal order or parent order to avoid date miscalculations which early renewing creates.
			$this-&gt;days_since_last_payment = floor( ( gmdate( &#039;U&#039; ) - $this-&gt;get_last_order_paid_time() ) / DAY_IN_SECONDS );
		}

		return $this-&gt;days_since_last_payment;
	}

	/**
	 * Gets the switch type.
	 *
	 * @since 2.6.0
	 * @return string Can be upgrade, downgrade or crossgrade.
	 */
	public function get_switch_type() {
		if ( ! isset( $this-&gt;switch_type ) ) {
			$old_price_per_day = $this-&gt;get_old_price_per_day();
			$new_price_per_day = $this-&gt;get_new_price_per_day();

			if ( $old_price_per_day &lt; $new_price_per_day ) {
				$switch_type = &#039;upgrade&#039;;
			} elseif ( $old_price_per_day &gt; $new_price_per_day &amp;&amp; $new_price_per_day &gt;= 0 ) {
				$switch_type = &#039;downgrade&#039;;
			} else {
				$switch_type = &#039;crossgrade&#039;;
			}

			$switch_type = apply_filters( &#039;wcs_switch_proration_switch_type&#039;, $switch_type, $this-&gt;subscription, $this-&gt;cart_item, $old_price_per_day, $new_price_per_day );

			if ( ! in_array( $switch_type, array( &#039;upgrade&#039;, &#039;downgrade&#039;, &#039;crossgrade&#039; ) ) ) {
				// translators: placeholder is a switch type.
				throw new UnexpectedValueException( sprintf( __( &#039;Invalid switch type &quot;%s&quot;. Switch must be one of: &quot;upgrade&quot;, &quot;downgrade&quot; or &quot;crossgrade&quot;.&#039;, &#039;woocommerce-subscriptions&#039; ), $switch_type ) );
			}

			$this-&gt;switch_type = $switch_type;
		}

		return $this-&gt;switch_type;
	}

	/** Calculator functions */

	/**
	 * Calculates the number of days in the old cycle.
	 *
	 * @since 2.6.0
	 * @return int
	 */
	public function calculate_days_in_old_cycle() {
		$method_to_use = &#039;days_between_payments&#039;;

		// If the subscription contains a synced product and the next payment is actually the first payment, determine the days in the &quot;old&quot; cycle from the subscription object
		if ( WC_Subscriptions_Synchroniser::subscription_contains_synced_product( $this-&gt;subscription ) ) {
			$first_synced_payment = WC_Subscriptions_Synchroniser::calculate_first_payment_date( wc_get_product( $this-&gt;canonical_product_id ), &#039;timestamp&#039;, $this-&gt;subscription-&gt;get_date( &#039;start&#039; ) );

			if ( $first_synced_payment === $this-&gt;next_payment_timestamp ) {
				$method_to_use = &#039;days_in_billing_cycle&#039;;
			}
		}

		// We need the product&#039;s billing cycle, not the trial length if the customer hasn&#039;t paid anything and it&#039;s still on trial.
		if ( $this-&gt;is_switch_during_trial() &amp;&amp; 0 === $this-&gt;get_total_paid_for_current_period() ) {
			$method_to_use = &#039;days_in_billing_cycle&#039;;
		}

		// If the last order was a switch order with a fully reduced pre-paid term.
		if ( $this-&gt;is_switch_after_fully_reduced_prepaid_term() ) {
			$method_to_use = &#039;days_between_switch_and_next_payment&#039;;
		}

		// Find the number of days between the last payment and the next
		if ( &#039;days_between_payments&#039; === $method_to_use ) {
			$days_in_old_cycle = round( ( $this-&gt;next_payment_timestamp - $this-&gt;get_last_order_paid_time() ) / DAY_IN_SECONDS );
		} elseif ( &#039;days_between_switch_and_next_payment&#039; === $method_to_use ) {
			$days_in_old_cycle = round( ( $this-&gt;next_payment_timestamp - $this-&gt;get_last_switch_order()-&gt;get_date_paid()-&gt;getTimestamp() ) / DAY_IN_SECONDS );
		} else {
			$days_in_old_cycle = wcs_get_days_in_cycle( $this-&gt;subscription-&gt;get_billing_period(), $this-&gt;subscription-&gt;get_billing_interval() );
		}

		return apply_filters( &#039;wcs_switch_proration_days_in_old_cycle&#039;, $days_in_old_cycle, $this-&gt;subscription, $this-&gt;cart_item );
	}

	/**
	 * Calculates the number of days in the new cycle.
	 *
	 * @since 2.6.0
	 * @return int
	 */
	public function calculate_days_in_new_cycle() {
		if ( $this-&gt;is_switch_after_fully_reduced_prepaid_term() ) {
			$last_order_time = $this-&gt;get_last_switch_order()-&gt;get_date_paid()-&gt;getTimestamp();
		} else {
			$last_order_time = $this-&gt;get_last_order_paid_time();
		}

		$new_billing_period   = WC_Subscriptions_Product::get_period( $this-&gt;product );
		$new_billing_interval = WC_Subscriptions_Product::get_interval( $this-&gt;product );

		// Calculate the number of days in the new cycle by finding what the renewal date would have been if the customer purchased the (new) product at the last payment date.
		// This gives us the most accurate number of days in the new cycle and a value that is similar to the number of days in the old cycle which is usually calculated by the the number of days between the last order and the next payment date.
		$days_in_new_cycle = ( wcs_add_time( $new_billing_interval, $new_billing_period, $last_order_time ) - $last_order_time ) / DAY_IN_SECONDS;

		// Find if the days in new cycle match the days in the old cycle,ignoring any rounding.
		$days_in_old_cycle = $this-&gt;get_days_in_old_cycle();
		$days_in_new_and_old_cycle_match = ceil( $days_in_new_cycle ) == $days_in_old_cycle || floor( $days_in_new_cycle ) == $days_in_old_cycle;

		// Set the days in each cycle to match if they are equal (ignoring any rounding discrepancy) or if the subscription is switched during a trial and has a matching trial period.
		if ( $days_in_new_and_old_cycle_match || ( $this-&gt;is_switch_during_trial() &amp;&amp; $this-&gt;trial_periods_match() ) ) {
			$days_in_new_cycle = $days_in_old_cycle;
		}

		return apply_filters( &#039;wcs_switch_proration_days_in_new_cycle&#039;, $days_in_new_cycle, $this-&gt;subscription, $this-&gt;cart_item, $days_in_old_cycle );
	}

	/** Helper functions */

	/**
	 * Determines whether the new product is virtual or not.
	 *
	 * @since 2.6.0
	 * @return bool
	 */
	public function is_virtual_product() {
		return $this-&gt;product-&gt;is_virtual();
	}

	/**
	 * Determines whether the new product&#039;s trial period matches the old product&#039;s trial period.
	 *
	 * @since 2.6.0
	 * @return bool
	 */
	public function trial_periods_match() {
		$existing_product = $this-&gt;existing_item-&gt;get_product();

		/**
		 * We need to cast the returned trial lengths as sometimes they may be strings.
		 * We also need to pass the new product&#039;s ID so the raw product&#039;s trial is used, not the filtered trial set by @see WC_Subscriptions_Switcher::maybe_unset_free_trial() &amp;&amp; WC_Subscriptions_Switcher::maybe_set_free_trial().
		 */
		$matching_length = (int) WC_Subscriptions_Product::get_trial_length( $this-&gt;product-&gt;get_id() ) === (int) WC_Subscriptions_Product::get_trial_length( $existing_product );
		$matching_period = WC_Subscriptions_Product::get_trial_period( $this-&gt;product-&gt;get_id() ) === WC_Subscriptions_Product::get_trial_period( $existing_product );

		return $matching_period &amp;&amp; $matching_length;
	}

	/**
	 * Determines whether the switch is happening while the subscription is still on trial.
	 *
	 * @since 2.6.0
	 * @return bool
	 */
	public function is_switch_during_trial() {
		return $this-&gt;subscription-&gt;get_time( &#039;trial_end&#039; ) &gt; gmdate( &#039;U&#039; );
	}

	/**
	 * Retrieves the subscription&#039;s last switch order.
	 *
	 * @since 3.0.7
	 * @return WC_Order|Null The last switch order or null if one doesn&#039;t exist.
	 */
	protected function get_last_switch_order() {
		static $switch_order = null;

		if ( ! $switch_order ) {
			$switch_order = $this-&gt;subscription-&gt;get_last_order( &#039;all&#039;, &#039;switch&#039; );
		}

		return $switch_order;
	}

	/**
	 * Determines if the last order was a switch and the outcome of that was a fully reduced pre-paid term.
	 *
	 * A fully reduced pre-paid term occurs when the amount the customer has paid (in total including switches) doesn&#039;t cover the amount of time that has elapsed already at the new price per day.
	 *
	 * For example:
	 * - Original purchase of a $70 / week subscription.
	 * - 5 days into the subscription the customer switches to a $120 / 3 days. The lower freqency triggers the pre-paid term to be reduced.
	 * - The $70 paid at $40 a day only entitles the customer to 1.75 days.
	 * - Because they are already 5 days into the subscription, that $70 is fully absorbed at the new price and no time is &#039;owed&#039;.
	 * - The subscription starts today and the customer pays full price.
	 *
	 * @see https://docs.woocommerce.com/document/subscriptions/switching-guide/#section-11
	 * @see WCS_Switch_Totals_Calculator::reduce_prepaid_term()
	 *
	 * @since 3.0.7
	 * @return bool Whether the last order was a switch and it fully reduced the prepaid term.
	 */
	protected function is_switch_after_fully_reduced_prepaid_term() {

		if ( ! isset( $this-&gt;is_switch_after_fully_reduced_prepaid_term ) ) {
			$last_switch_order = $this-&gt;get_last_switch_order();

			if ( empty( $last_switch_order ) || ! $last_switch_order-&gt;get_date_paid() ) {
				$this-&gt;is_switch_after_fully_reduced_prepaid_term = false;
				return false;
			}

			$switch_paid_date = $last_switch_order-&gt;get_date_paid();

			// If the last switch order occured after the last payment order (parent or renewal)
			if ( $switch_paid_date-&gt;getTimestamp() &lt; $this-&gt;get_last_order_paid_time() ) {
				$this-&gt;is_switch_after_fully_reduced_prepaid_term = false;
				return false;
			}

			/**
			 * If the last switch resulted in the customer being charged the pull cost upfront, the customer must have been entitled to fewer days than had already elapsed - see reduce_prepaid_term().
			 * This means the subscription billing term would have started from that switch order&#039;s date, not the last order (parent/renewal) date.
			 */
			$first_payment_after_switch = WC_Subscriptions_Product::get_first_renewal_payment_time( $this-&gt;existing_item-&gt;get_product(), gmdate( &#039;Y-m-d H:i:s&#039;, $switch_paid_date-&gt;format( &#039;U&#039; ) ) );

			// If the first payment date after the last switch is roughly equal (+- 1 hour) to the next payment date, then it was a fully reduced pre-paid term switch.
			$this-&gt;is_switch_after_fully_reduced_prepaid_term = ( $this-&gt;next_payment_timestamp - HOUR_IN_SECONDS &lt;= $first_payment_after_switch ) &amp;&amp; ( $first_payment_after_switch &lt;= $this-&gt;next_payment_timestamp + HOUR_IN_SECONDS );
		}

		return $this-&gt;is_switch_after_fully_reduced_prepaid_term;
	}

	/**
	 * Determines whether the customer is switching to a subscription with a length of 1 - one off payment.
	 *
	 * @since 3.0.12
	 * @return bool
	 */
	public function is_switch_to_one_payment_subscription() {
		return 1 === absint( WC_Subscriptions_Product::get_length( $this-&gt;product ) );
	}
}
</code></pre>
            </article>
            </div>
        </div>
        <a href="#top" class="phpdocumentor-back-to-top"><i class="fas fa-chevron-circle-up"></i></a>

    </main>

    <footer class="phpdocumentor phpdocumentor-footer">
    <div class="phpdocumentor-section">
        <span>WooCommerce Code Reference API documentation generated by <a href="http://www.phpdoc.org/">phpDocumentor</a> on September 20th, 2022 at 07:45 am.</span>
    </div>
</footer>

    <script>
        cssVars({});
    </script>
    <script>
        var searchParams = {
            'searchIndex': '..\/js\/searchIndex.json'
        };
    </script>
    <script src="../js/searchIndex.js?updated=1663659953"></script>
    <script src="../js/search.js?updated=1663659953"></script>
</body>
</html>
